
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>sjpsega's Blog</title>
  <meta name="author" content="sjpsega">

  
  <meta name="description" content="WKWebView Apple 从 iOS 8 开始，引入了新的 WebView 类 WKWebView，试图替换已经老迈的 UIWebView。 优点 通过官方的描述，和自己实际测试，WKWebView功能相当强大，对比 UIWebView 的优点很多： 更少的内存使用，渲染相同页面， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--友言验证-->
  <meta name="uyan_auth" content="7d2af41cee" />

  
  <link rel="canonical" href="http://sjpsega.me/posts/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="sjpsega's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/jquery.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts 
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->
  

  <script type="text/javascript">
  //链接新开窗口
  function addBlankTargetForLinks () {
      $('a[href^="http"]').each(function(){
          $(this).attr('target', '_blank');
      });
  }
  $(document).ready(function(event) {
      addBlankTargetForLinks();
  });
  </script>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">sjpsega's Blog</a></h1>
  
    <h2>记录我的生活与学习.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="sjpsega.me">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
  <li><a href="/blog/categories/study">学习</a></li>
  <li><a href="/blog/categories/life">生活</a></li>
  <li><a href="http://weibo.com/sjpsega" target="_blank">我的微博</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/06/cordova-wkwebview-study-1/">Cordova WKWebView 学习笔记（一）</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-02-06T13:43:47+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>1:43 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>WKWebView</h2>

<p>Apple 从 iOS 8 开始，引入了新的 WebView 类 <code>WKWebView</code>，试图替换已经老迈的 UIWebView。</p>

<h3>优点</h3>

<p>通过官方的描述，和自己实际测试，WKWebView功能相当强大，对比 UIWebView 的优点很多：</p>

<ul>
<li>更少的内存使用，渲染相同页面，占用内存基本只有 UIWebView 的 1/3 ~ 1/4，并且大大减少了内存泄露的情况</li>
<li>使用与 Safari 一样的性能强大的 Nirtro JS 引擎</li>
<li>异常强大的 app 与 web 的内容传递

<ul>
<li>可以使用 <code>WKUserContentController</code> 在 Native 端注入用户自定义脚本 JS</li>
<li>web 端可以使用 <code>window.webkit.messageHandlers.{NAME}.postMessage()</code>，直接向 Native 端发送消息。UIWebView 只能使用 iframe 等方案 hack</li>
</ul>
</li>
</ul>


<h3>限制</h3>

<p>官方的描述基本是溢美之词，他不会告诉你 WKWebView 的一些问题，但是这些问题，在做 Hybrid 应用的时候，影响很大，纯 wap 无影响。
估计是切换底层实现的关系，这些问题在 UIWebView 上不存在：</p>

<ul>
<li>无能加载本地文件，只能通过内建一个 WebServer 实现功能。（直到 iOS 9 才新开了一个loadFileURL:allowingReadAccessToURL: 接口，原生实现该功能）</li>
<li>不能注册自定义 NSURLProtocol，导致大量 URL 拦截功能难以实现，比如页面展示本地图片</li>
<li>不能使用 NSHTTPCookieStorage 设置 WebView 的 Cookie</li>
<li>必须 iOS8 及以上版本，Cordova 只支持 iOS9 及以上</li>
</ul>


<p>还有其他在实际开发中，可能爆出的 bug。</p>

<h2>Cordova WKWebview 现状</h2>

<p>Cordova 开发了<a href="https://github.com/apache/cordova-plugin-wkwebview-engine">一个插件</a>来支持 WKWebview，用户可以自行在 WKWebview 与 UIWebView 中选择。</p>

<p>但因为 WKWebView 存在的种种问题，WKWebView 还不是 Cordova 的默认选择。</p>

<p><a href="https://shazronatadobe.wordpress.com/2015/03/03/wkwebview-and-apache-cordova/">cordova 关于 WKWebView 的一些说明</a></p>

<h2>结论</h2>

<ul>
<li>纯 wap 页面，WKWebView 毫无问题，会有很好的表现</li>
<li>Hybrid 应用，因为现在存在的一些问题，以及会导致实现 Camera、PhotoList 等 JSBridge 的功能上会有较大限制，选择 WKWebView 需要慎重</li>
</ul>


<h2>相关代码</h2>

<p><a href="https://github.com/apache/cordova-plugin-wkwebview-engine">cordova-plugin-wkwebview-engine</a></p>

<p><a href="https://github.com/crosswalk-project/ios-extensions-crosswalk">CrossWalk Cordova Plugin Support</a></p>

<h2>相关资料</h2>

<p><a href="http://nshipster.cn/wkwebkit/">WKWeb​View</a></p>

<p><a href="http://docs.telerik.com/platform/appbuilder/cordova/configuring-your-app/configure-web-views">Telerik Platform Documentation - Configure the Web Views</a></p>

<p><a href="http://plugins.telerik.com/cordova/plugin/wkwebview">Cordova Plugins - WKWebView</a></p>

<p><a href="https://crosswalk-project.org/documentation/ios/cordova_plugin_support.html">CrossWalk - Cordova Plugin Support</a></p>

<p><a href="http://stackoverflow.com/questions/29268433/is-there-support-in-cordova-to-wkwebview">Is there support in Cordova to WKWebView?</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/14/isequalandhash/">isEqual 与 Hash</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-14T01:17:56+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>1:17 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>最佳实践</h2>

<ul>
<li>实现 <code>isEqualTo__ClassName__</code></li>
<li>重写 isEqual 方法，同时重写 hash 方法。</li>
</ul>


<h2>关系</h2>

<ul>
<li>两个对象 isEqual 相等，hash 必须也相等</li>
<li>两个对象 hash 相同，isEqual 则不一定相等</li>
</ul>


<h2>碰撞</h2>

<p>当对象存入集合对象时（Array，Set，HashTable等），内部会使用对象的 hash 值来作为 key 来存入。
当两个不相等的对象，有相同的 hash 值，存入集合对象，就会发生<code>碰撞</code>现象。
发生碰撞现象，对使得存取数据变慢，所以需要尽量避免这个现象，但不可能完全避免。</p>

<h2>作为集合对象 key 的注意点</h2>

<ul>
<li>实现 isEqual 和 hash 方法，遵守两者关系，尽量避免 hash 碰撞的情况发生</li>
<li>实现 NSCopying 协议，接口：<code>- (void)setObject:(ObjectType)anObject forKey:(KeyType &lt;NSCopying&gt;)aKey;</code></li>
</ul>


<h2>测试 Demo</h2>

<p><a href="https://github.com/sjpsega/EqualAndHashTest">测试 Demo</a></p>

<h2>参考资料</h2>

<p><a href="http://nshipster.com/equality/">Equality</a></p>

<p><a href="https://mikeash.com/pyblog/friday-qa-2010-06-18-implementing-equality-and-hashing.html">Implementing Equality and Hashing</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/31/gcd-study/">GCD 学习</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-31T00:08:49+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>12:08 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Grand Central Dispatch （GCD）是 Apple 开发的一个多核编程的解决方法。</p>

<p>底层、轻量，是 iOS 上常用的多线程解决方案。</p>

<h2>基本操作</h2>

<h3>sync、async</h3>

<p>dispatch_sync （同步）添加任务到一个队列并等待，直到任务完成，再执行原有队列上的任务。</p>

<p>dispatch_async （异步）添加任务到一个队列，但继续执行原有队列上的任务，在队列中按照 FIFO 的规则执行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">dispatch_sync</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;log 1&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;log 2&quot;</span><span class="p">);</span>
</span><span class='line'><span class="o">/*</span> <span class="err">输出</span><span class="o">:</span>
</span><span class='line'> <span class="o">*</span> <span class="n">log</span> <span class="mi">1</span>
</span><span class='line'> <span class="o">*</span> <span class="n">log</span> <span class="mi">2</span>
</span><span class='line'> <span class="o">*</span> <span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;log 1&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;log 2&quot;</span><span class="p">);</span>
</span><span class='line'><span class="o">/*</span> <span class="err">输出绝大多数情况为</span><span class="o">:</span>
</span><span class='line'> <span class="o">*</span> <span class="n">log</span> <span class="mi">2</span>
</span><span class='line'> <span class="o">*</span> <span class="n">log</span> <span class="mi">1</span>
</span><span class='line'> <span class="o">*</span> <span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>注：不能在串行（主线程是一种串行队列）线程队列的任务中，再使用 dispatch_sync 添加任务到同一个串行队列中，否则必定发生死锁。</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="c1">//必定发生死锁</span>
</span><span class='line'>    <span class="n">dispatch_sync</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>dispatch_once</h3>

<p>dispatch_once 线程安全的方式执行任务且仅执行其代码块一次。</p>

<p>在单例模式中普遍使用。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">static</span> <span class="kt">dispatch_once_t</span> <span class="n">onceToken</span><span class="p">;</span>
</span><span class='line'><span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;log 1&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;log 2&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="o">/*</span> <span class="err">输出</span><span class="o">:</span>
</span><span class='line'> <span class="o">*</span> <span class="n">log</span> <span class="mi">1</span>
</span><span class='line'> <span class="o">*</span> <span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>


<h3>dispatch_after</h3>

<p>dispatch_after 延后一定时间，异步执行任务</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">dispatch_after</span><span class="p">(</span><span class="n">dispatch_time</span><span class="p">(</span><span class="n">DISPATCH_TIME_NOW</span><span class="p">,</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">NSEC_PER_SEC</span><span class="p">)),</span> <span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;log 1&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;log 2&quot;</span><span class="p">);</span>
</span><span class='line'><span class="o">/*</span> <span class="err">输出</span><span class="o">:</span>
</span><span class='line'> <span class="o">*</span> <span class="n">log</span> <span class="mi">2</span>
</span><span class='line'> <span class="o">*</span> <span class="n">log</span> <span class="mi">1</span>
</span><span class='line'> <span class="o">*</span> <span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>


<h2>group</h2>

<p>通常使用分组来关联一组相关的任务，任务全部完成后，再做相关操作。</p>

<h3>group_enter、group_leave</h3>

<p>使用 dispatch_group_enter、dispatch_group_leave 来手动设置一个组任务的开始和结束，用来控制复杂情况下的任务完成情况。</p>

<p>必须保证 dispatch_group_enter 和 dispatch_group_leave <code>成对出现</code>，否则会遇到崩溃问题。</p>

<p>实例：</p>

<p>a）不使用 dispatch_group_enter、dispatch_group_leave 的情况</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testGCDWithGroup</span><span class="p">{</span>
</span><span class='line'>    <span class="k">__block</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">__block</span> <span class="kt">BOOL</span> <span class="n">isDone</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="kt">dispatch_group_t</span> <span class="n">group</span> <span class="o">=</span> <span class="n">dispatch_group_create</span><span class="p">();</span>
</span><span class='line'>    <span class="c1">// 2</span>
</span><span class='line'>    <span class="n">dispatch_group_async</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;CGD 1 .&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">// 3</span>
</span><span class='line'>        <span class="n">dispatch_after</span><span class="p">(</span><span class="n">dispatch_time</span><span class="p">(</span><span class="n">DISPATCH_TIME_NOW</span><span class="p">,</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)(</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">NSEC_PER_SEC</span><span class="p">)),</span> <span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;CGD 1 after.&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="n">dispatch_group_notify</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;done !!!&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">// 4</span>
</span><span class='line'>        <span class="n">isDone</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">count</span><span class="p">).</span><span class="n">to</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="c1">// 5</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">isDone</span><span class="p">).</span><span class="n">will</span><span class="p">.</span><span class="n">beTruthy</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>该测试用例执行步骤为:</p>

<ol>
<li>生成一个自定义组</li>
<li>在自定义组上，添加任务到子线程上执行</li>
<li>子线程上的任务为执行一个延时任务，使得 count + 1</li>
<li>当一个组内的任务全部完成，设置 isDone 为 YES，并期望 count 为 1</li>
<li>异步执行，期望 isDone 为 YES</li>
</ol>


<p>期望4、5处的测试均能通过，但测试结果为：</p>

<ol>
<li>5 的测试 case 为通过</li>
<li>4 的测试 case <code>不通过</code>，count 不为 1</li>
</ol>


<p>因为在这个例子中，执行完毕 dispatch_group_async 中的任务，就算任务完成了；而不是等到 dispatch_group_async 中的 dispatch_after 任务完成，才算任务完成。</p>

<p>b）使用 dispatch_group_enter、dispatch_group_leave 的情况</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testGCDWithGroupEnterAndLeave</span><span class="p">{</span>
</span><span class='line'>    <span class="k">__block</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">__block</span> <span class="kt">BOOL</span> <span class="n">isDone</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">dispatch_group_t</span> <span class="n">group</span> <span class="o">=</span> <span class="n">dispatch_group_create</span><span class="p">();</span>
</span><span class='line'>    <span class="n">dispatch_group_enter</span><span class="p">(</span><span class="n">group</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dispatch_group_async</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;CGD 1 .&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">dispatch_after</span><span class="p">(</span><span class="n">dispatch_time</span><span class="p">(</span><span class="n">DISPATCH_TIME_NOW</span><span class="p">,</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)(</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">NSEC_PER_SEC</span><span class="p">)),</span> <span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;CGD 1 after.&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">dispatch_group_leave</span><span class="p">(</span><span class="n">group</span><span class="p">);</span>
</span><span class='line'>            <span class="n">count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="n">dispatch_group_notify</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;done !!!&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">isDone</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">count</span><span class="p">).</span><span class="n">to</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">isDone</span><span class="p">).</span><span class="n">will</span><span class="p">.</span><span class="n">beTruthy</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个测试用例的全部通过，使用手动控制组任务的开始和结束，完美解决了例子 a 中碰到的问题。</p>

<p>使用 dispatch_group_enter、dispatch_group_leave，用来处理复杂的异步任务非常有效。</p>

<h2>queue</h2>

<h3>串行、并发</h3>

<p>串行队列每次只有一个任务被执行，并发队列在同一时间可以有多个任务被执行。</p>

<p>主线程是系统提供的一个特殊的队列，是一个<code>串行</code>队列，是唯一可用与更新 UI 的线程。</p>

<p>除了主线程，其他均为子线程，通常用来执行与 UI 无关的操作。
实际编码中，通常使用 <code>dispatch_get_global_queue(long identifier, unsigned long flags)</code> 来获取子线程队列。通过该方法获取的是<code>并发</code>的全局调度队列，并且可以设置四个不同优先级的队列：high、default、low、background，若没有特殊原因，只使用 default 级别的队列。</p>

<p>用户还可以使用 <code>dispatch_queue_create(const char *label, dispatch_queue_attr_t attr)</code> 来创建自定义的串行或并发队列。
主线程是系统提供的<code>串行</code>队列。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">//创建自定义并发队列</span>
</span><span class='line'><span class="kt">dispatch_queue_t</span> <span class="n">concurrentQueue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">&quot;com.sjpsega&quot;</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_CONCURRENT</span><span class="p">);</span>
</span><span class='line'><span class="c1">//创建自定义创兴队列</span>
</span><span class='line'><span class="kt">dispatch_queue_t</span> <span class="n">serialQueue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">&quot;com.sjpsega&quot;</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_SERIAL</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>dispatch_barrier</h2>

<p>barrier 意为“障碍”。dispatch_barrier 在并发队列上工作时扮演一个串行式的瓶颈。当提交的任务开始执行时，该 API 保障这个时刻队列里只执行当前任务，不会执行其他任务。</p>

<p><img src="/images/2015-08-31-gcd-study/dispatch_barrier.png" alt="dispatch_barrier" /></p>

<p>使用 dispatch_barrier API 最佳的方式是使用<code>自定义并发队列</code>执行。</p>

<p>下面以使用 dispatch_barrier 保证类类变量线程安全为例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addStudents:</span><span class="p">(</span><span class="n">Student</span> <span class="o">*</span><span class="p">)</span><span class="nv">student</span><span class="p">{</span>
</span><span class='line'>    <span class="n">dispatch_barrier_async</span><span class="p">(</span><span class="n">_concurrentQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">_students</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">student</span><span class="p">];</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nf">students</span><span class="p">{</span>
</span><span class='line'>    <span class="k">__block</span> <span class="bp">NSArray</span> <span class="o">*</span><span class="n">copyObj</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dispatch_sync</span><span class="p">(</span><span class="n">_concurrentQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">copyObj</span> <span class="o">=</span>  <span class="p">[</span><span class="n">_students</span> <span class="k">copy</span><span class="p">];</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">copyObj</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是，通常保证类变量线程安全，若不是高并发的情况下，比较简单的方式是使用 <code>synchronized</code> 关键字：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addStudents:</span><span class="p">(</span><span class="n">Student</span> <span class="o">*</span><span class="p">)</span><span class="nv">student</span><span class="p">{</span>
</span><span class='line'>    <span class="k">@synchronized</span><span class="p">(</span><span class="n">_students</span><span class="p">){</span>
</span><span class='line'>        <span class="p">[</span><span class="n">_students</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">student</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nf">students</span><span class="p">{</span>
</span><span class='line'>    <span class="k">@synchronized</span><span class="p">(</span><span class="n">_students</span><span class="p">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">_students</span> <span class="k">copy</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>测试 Demo</h2>

<p><a href="https://github.com/sjpsega/GCDTest">测试 Demo</a></p>

<h2>参考资料</h2>

<p><a href="https://github.com/nixzhu/dev-blog/blob/master/2014-04-19-grand-central-dispatch-in-depth-part-1.md">GCD 深入理解：第一部分</a></p>

<p><a href="https://github.com/nixzhu/dev-blog/blob/master/2014-05-14-grand-central-dispatch-in-depth-part-2.md">GCD 深入理解：第二部分</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/15/uiwebview-cache-bug-by-custom-protocol/">iOS UIWebView 自定义协议文件加载缓存问题</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-15T22:56:31+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:56 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>起因</h2>

<p>一个简单的需求：为了减少网络请求，一些前端资源会做本地缓存；使用 WebView 访问页面的时候，拦截特定请求，使得特定请求直接加载本地资源。</p>

<p>但是做的过程中发现，当请求的资源为自定义协议的时候，比如加载的 url 为 <code>abc://xxx.com/xx.js</code> 的时候，系统会强制对该资源做缓存，并且调用系统提供的清除缓存接口，如 <code>[[NSURLCache sharedURLCache] removeAllCachedResponses]</code>， 都无法清除该缓存，除非重启 App。</p>

<p>这就导致该资源内容发生变化的时候，无法立即生效，这在业务中，显然是不能接受的。</p>

<p><code>注</code>：该方案主要针对 <code>UIWebView</code> 有效；<code>WKWebView</code> 因为不能使用自定义 NSURLProtocol 拦截资源，方法二就不起作用。</p>

<h2>解决</h2>

<h3>方法一：html 模板上，资源 url 加上随机字符串</h3>

<p>在 html 页面上修改 url 字符串，如 <code>abc://xxx.com/xx.js</code>，需要改成 <code>abc://xxx.com/xx.js?t=123</code>，这样系统就不会缓存该资源。</p>

<p>该方法简单直接。</p>

<h3>方法二：创建自定义 NSURLProtocol，拦截请求，并且在创建 response 时，修改自定义协议为 http 或 https</h3>

<p>伪代码如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">//原请求</span>
</span><span class='line'><span class="bp">NSString</span> <span class="o">*</span><span class="n">requestURLString</span> <span class="o">=</span> <span class="s">@&quot;abc://xxx.com/xx.js&quot;</span><span class="p">;</span>
</span><span class='line'><span class="c1">//根据原请求获得的 data 数据</span>
</span><span class='line'><span class="bp">NSData</span> <span class="o">*</span><span class="n">abcData</span> <span class="o">=</span> <span class="p">...</span>
</span><span class='line'><span class="c1">//将原请求的自定义协议改成 http</span>
</span><span class='line'><span class="bp">NSString</span> <span class="o">*</span><span class="n">changeURLString</span> <span class="o">=</span> <span class="s">@&quot;http://xxx.com/xx.js&quot;</span><span class="p">;</span>
</span><span class='line'><span class="c1">//创建 response</span>
</span><span class='line'><span class="bp">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="n">changeURLString</span><span class="p">];</span>
</span><span class='line'><span class="bp">NSURLResponse</span><span class="o">*</span> <span class="n">response</span> <span class="o">=</span>
</span><span class='line'><span class="p">[[</span><span class="bp">NSURLResponse</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithURL</span><span class="p">:</span><span class="n">url</span>
</span><span class='line'>                          <span class="nl">MIMEType</span><span class="p">:</span><span class="s">@&quot;application/x-javascript&quot;</span>
</span><span class='line'>             <span class="nl">expectedContentLength</span><span class="p">:</span><span class="n">abcData</span><span class="p">.</span><span class="n">length</span>
</span><span class='line'>                  <span class="nl">textEncodingName</span><span class="p">:</span><span class="s">@&quot;UTF-8&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">[[</span><span class="nb">self</span> <span class="n">client</span><span class="p">]</span> <span class="nl">URLProtocol</span><span class="p">:</span><span class="nb">self</span> <span class="nl">didReceiveResponse</span><span class="p">:</span><span class="n">response</span> <span class="nl">cacheStoragePolicy</span><span class="p">:</span><span class="n">NSURLCacheStorageNotAllowed</span><span class="p">];</span>
</span><span class='line'><span class="p">[[</span><span class="nb">self</span> <span class="n">client</span><span class="p">]</span> <span class="nl">URLProtocol</span><span class="p">:</span><span class="nb">self</span> <span class="nl">didLoadData</span><span class="p">:</span><span class="n">abcData</span><span class="p">];</span>
</span><span class='line'><span class="p">[[</span><span class="nb">self</span> <span class="n">client</span><span class="p">]</span> <span class="nl">URLProtocolDidFinishLoading</span><span class="p">:</span><span class="nb">self</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>本来结合方法一的解决方式，创建 response 的时候，在 url 后加上随机字符串，但是经过试验，该方案<code>无效</code>，缓存始终存在。</p>

<p>使用该解决方法解决缓存问题，据个人猜测是因为，iOS 系统默认缓存数据，但针对 http 或 https 协议会根据 Cache-Control 等字段判断是否缓存。</p>

<p>具体可见 <a href="https://github.com/sjpsega/CustomProtocolCacheTest">测试demo</a>，并注意 log 信息。</p>

<h2>讨论</h2>

<p>解决这个缓存问题，其实我还是有些疑惑，因为试了所有 iOS 给出的数据缓存 API，都不起作用。这些包括：</p>

<ul>
<li>使用 [[NSURLCache sharedURLCache] removeAllCachedResponses] 清理缓存</li>
<li>重写了 NSURLCache 的 - (NSCachedURLResponse <em>)cachedResponseForRequest:(NSURLRequest </em>)request 方法，不返回 response 对象</li>
<li>自定义 NSURLProtocol 中，使用 NSURLConnection 加载数据，实现 NSURLConnectionDelegate 的 - (NSCachedURLResponse <em>)connection:(NSURLConnection </em>)connection willCacheResponse:(NSCachedURLResponse *)cachedResponse 方法，返回 nil，不做对应 url 数据的缓存。</li>
</ul>


<p>然后，方法一与方法二中，我都试验了 url 加随机字符串的方式，但是为什么 html 模板上的资源 url 加上随机字符串有效，创建 response 时候，url 加上随机字符串无效，我也感到无解。</p>

<p>感觉在 webView 资源缓存的问题上，Apple 官方还是有些接口没开放，或者是我不知道&hellip;</p>

<h2>参考资料</h2>

<p><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/URLLoadingSystem/URLLoadingSystem.html#//apple_ref/doc/uid/10000165i">URL Loading System</a></p>

<p><a href="http://nshipster.cn/nsurlcache/">NSURLCache</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/27/taiwanyou/">台湾游记</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-27T01:41:49+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:41 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>4 月份天气不冷不热，是个出游的好时期。趁着工作上的事情暂时告一段落，忙里偷闲，delay 了近半年的台湾游终于成行。</p>

<h2>注意事项</h2>

<p>因为是跟团游，所以操心的事情不多，去台湾前看了一些别人的攻略，自己去了次，体会更深了，记录下。</p>

<ul>
<li>去机场坐飞机一定要赶早。
去的那天因为我们要去上海浦东坐下午1点10分的飞机，本以为早上8点去武林广场坐大巴来得及，结果大巴要开3个半小时，顺利的话，11点半到机场。但是坐国际航班需要提前2个小时检票，时间太紧张，结果我们雇了辆小车，和一个大哥拼车，我们俩人花了800RMB，赶到机场&hellip;</li>
<li>货币兑换最好带RMB到台湾再换。在台湾的机场用RMB换台币，汇率好，兑换金额不限，每笔只要30台币（约6RMB）。回大陆前，还能在机场换回RMB。
我自己是带了招行卡去台湾ATM机上换的，结果每笔最低10RMB手续费，换的多，手续费更高。听说华夏卡免手续费，但是我没有这卡，无从验证。</li>
<li>台湾电信运营商针对游客的7天无限流量套餐蛮划算的，450新台币，可在机场或代理商店里办理，很方便。这年头没网上怎么行。</li>
</ul>


<h2>台湾印象</h2>

<p>跟团游时间很紧，基本是上车睡觉，下车拍照的模式，再加上购物点有点多，蛮郁闷的。
但是这丝毫不影响我们对台湾的好印象，简单的说就是民风纯朴，风景秀丽。</p>

<h3>day 1</h3>

<p>第二天的路线是：国父纪念馆 -> 101大厦 -> 士林夜市 -> 福华大酒店
我们从桃园机场着陆，到达宝岛台湾，坐车很快就到了台北，台湾的城市比较小，从一个城市开车很快就到另一个城市了，在大陆是不可想象的。</p>

<ul>
<li>在国父纪念馆看了交接仪式和降旗仪式，简单了解了孙中山的生平。</li>
<li>101大厦89楼鸟瞰了台北的全景，和全球唯一外露的，可供游客参观的<a href="http://baike.baidu.com/link?url=gByDUgpWBQRL0EzaOtar4Sma6NquYdUljNg4IXVXqPZzwPEo1ss-svGZ7X1YJzeWSxpqXSVDjYtAkA50xx2bTq">风阻尼器</a>。</li>
<li>在士林夜市吃了许多台湾的地道美食，有拍摄《转角遇到爱》的大头龙的蚵仔煎，号称比脸大的豪大大鸡排，名字奇怪的棺材板等等。
吃完美食，回到第一晚的酒店，福华大酒店，据说很有名。放下行李，立马去市区转转，我的目的是去办个手机卡，用来上网。因为不熟悉路，问了好几次台北的路人，才好不容易找到了中华电信办理了手机卡。通过问路，问的几个都是年轻人，都特别耐心，给人的印象很好，特别是一个便利店的店员，问他路的时候，店里其实蛮忙的，他特意放下手头的工作，让同事打理，把我们领到店门口给我们指路。</li>
</ul>


<h3>day 2</h3>

<p>第二天的路线是：士林官邸 -> 台北故宫博物馆 -> 维格饼屋 -> 日月潭大酒店</p>

<ul>
<li>士林官邸是老蒋的住处，地方很大，环境优美，有教堂，有花园，是个养人的好地方。</li>
<li>台北故宫博物馆，诠释了浓缩就是精华，东西不多，但都是精品。规定有点多：不能穿拖鞋、不能背双肩包、不能带水杯进去、不能带单反、不准拍照等等。</li>
<li>维格饼屋是第一个购物点，维格有名的是凤梨酥。比较有意思的是，在这里要亲手做凤梨酥。因为店家已经准备好了馅料和面团，所以只要稍微揉搓，放入馅料，搓成团，然后放入模具，造型各异的凤梨酥就搞定了。
在这里买了点凤梨酥、绿豆糕、牛轧糖，准备回去给家人朋友带点。值得一说的是，我觉得绿豆糕比凤梨酥好吃多了。</li>
<li>下午基本是在车上度过，大概3个小时的行程，从台北赶到了日月潭，到达的酒店的时候，天色已晚。
晚餐在酒店里吃自助，自助很赞，连鲍鱼、螃蟹、鱿鱼、生鱼片、刺身都有。但我最喜欢这里的粉丝担仔面，加上一勺辣椒，特美味。
吃完晚餐，到日月潭的街区逛了逛，这里给人的感觉非常宁静，人不多。之前给我有相同感觉的是日本的河口湖，都是在湖边的小镇。</li>
</ul>


<h3>day 3</h3>

<p>第三天的行程：日月潭 -> 九族文化村 -> 钰通大饭店</p>

<ul>
<li>日月潭蛮大的，湖水是湛蓝的，水深达700余米，感觉像云南的洱海，天蓝水蓝，浑然一体。早上一团人坐游艇在日月潭里兜了一圈，游览了玄光寺。值得一说的是，玄光寺这里买的凤梨是本次在台湾吃到的最好吃的，很甜。</li>
<li>下午在日月潭旁，坐缆车来到了九族文化村，这里看了传统的民俗表演，还有好多刺激的游乐设施，比如疯狂过山车等等。</li>
<li>再坐车到嘉义，晚饭吃了小火锅，晚上入住钰通大饭店。说是这里是台湾的乡下，但是和大陆的乡下感觉不同，大陆的乡下破破的，真是乡下；台湾的乡下该有的都有，比大城市空旷些，感觉住在这里很舒服。</li>
</ul>


<h3>day 4</h3>

<p>第四天的行程：阿里山 -> yuyupas 邹族文化园区 -> 高雄85大楼君鸿大酒店 -> 六合夜市</p>

<ul>
<li>早晨早早起床，6点半出发前往阿里山，看了阿里山神木。因为是跟团游，大巴上山，大巴下山，少了爬山的感觉，对阿里山的感觉一般，再加上大陆的名山大川很多。</li>
<li>yuyupas 邹族文化园区，又是一个购物点，这里主要是卖茶叶，阿里山山茶，喝了点，口感一般。</li>
<li>下午坐车来到高雄，入住85大楼君鸿大酒店，背靠高雄港，很气派。</li>
<li>晚上晚餐自理，我们来到六合夜市，这是个观光客居多的夜市，每个小吃平均是100新台币，价格还行。吃了这里的超有名的郑老牌木瓜牛奶，马英九都来吃过三次；老师傅烤制的泰国虾等等。</li>
</ul>


<h3>day 5</h3>

<p>第五天的行程：旗津海岸公园 -> 猫鼻头公园 -> 恒春渔港吃海鲜 -> 关山看日落 -> 福华度假酒店 -> 垦丁大街</p>

<ul>
<li>早上轮渡到旗津看海，因为天气有点燥热，加上没随身带凉鞋，拍了拍照就走了。看了一间庙宇，在旁边的一间冰铺吃了好吃的芒果刨冰。</li>
<li>坐车来到台湾岛南端 - 垦丁，一路上看到好多凤梨、香蕉树，在猫鼻头公园看了天蓝海蓝的美景。</li>
<li>来到恒春的一个小渔港吃海鲜，因为这里来吃的不仅有游客，还有台湾本地人，所以价格还不错；特别是生鱼片，100新台币有近20片，但是我对生鱼片无爱啊&hellip;在这里吃了两个打海鲜，共花了2500新台币，是在台湾最奢侈的一餐了。</li>
<li>吃完海鲜，5点前往关山看日落。在天蓝海蓝的地方看日落真美。</li>
<li>晚上入住福华度假酒店，酒店里的土著木雕、椅子等，很特别。</li>
<li>逛了带感的垦丁大街，吃了点小吃。</li>
</ul>


<h3>day 6</h3>

<p>第五天的行程：台湾最南点 -> 龙磐公园 -> 恒春古城 -> 高雄国际机场</p>

<ul>
<li>在台湾岛最南端，走过一处幽静的小路，看到最南端的标志建筑。</li>
<li>龙磐公园是一个天大地大草原小的地方，很漂亮，在悬崖边看海，别有一番风味。</li>
<li>恒春古城很一般，就是一处复建的城墙……</li>
<li>然后，6天行程结束，依依不舍坐飞机回家……</li>
</ul>


<h3>结语</h3>

<p>这次的台湾游运气这不错，6天都是晴空万里，只有第6天下了一点点小雨，还躲过了今年为止台湾最大的花莲地震。
台湾很美，时间太少，行程太赶，愿下次再来。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/25/reset-webview-zoom-with-ios/">重置 iOS UIWebView 的缩放</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-25T14:01:19+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:01 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>需求</h2>

<p>遇到一个需求，iOS webView设置了可缩放，用户缩放webView后，做某个操作，需要将webView的缩放重置。</p>

<h2>经过</h2>

<p>在网上找了下，看到很多很多解决方案，不论是国内的，还是国外的解决方案，但是实际使用都没有效果……</p>

<h2>解决</h2>

<p>经过不断尝试，发现以下方式是有效果的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">//重置 webView 的 html viewport 属性，变成不可缩放，并且缩放比例为1.0，并执行javaScript</span>
</span><span class='line'><span class="cp">#define QUOTE(...) #__VA_ARGS__</span>
</span><span class='line'><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">webViewHeightJSString</span> <span class="o">=</span> <span class="n">QUOTE</span><span class="p">(</span>
</span><span class='line'><span class="n">var</span> <span class="n">viewportmeta</span> <span class="o">=</span> <span class="n">document</span><span class="p">.</span><span class="n">querySelector</span><span class="p">(</span><span class="err">&#39;</span><span class="n">meta</span><span class="p">[</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span><span class="p">]</span><span class="err">&#39;</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">viewportmeta</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="n">viewportmeta</span><span class="p">.</span><span class="n">content</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">width</span><span class="o">=</span><span class="n">device</span><span class="o">-</span><span class="n">width</span><span class="p">,</span> <span class="n">initial</span><span class="o">-</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>      <span class="n">minimum</span><span class="o">-</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">-</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">user</span><span class="o">-</span><span class="n">scalable</span><span class="o">=</span><span class="n">no</span><span class="err">&#39;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'><span class="cp">#undef QUOTE</span>
</span><span class='line'><span class="p">[</span><span class="n">webView</span> <span class="nl">stringByEvaluatingJavaScriptFromString</span><span class="p">:[</span><span class="bp">NSString</span> <span class="nl">stringWithUTF8String</span><span class="p">:</span><span class="n">webViewHeightJSString</span><span class="p">]];</span>
</span><span class='line'><span class="c1">//设置 webView zoomScale 为 1.0，且必须设置animated为YES</span>
</span><span class='line'><span class="p">[</span><span class="n">webView</span><span class="p">.</span><span class="n">scrollView</span> <span class="nl">setZoomScale</span><span class="p">:</span><span class="mf">1.0</span> <span class="nl">animated</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>此方法在iOS7、8上的 UIWebView 上测试通过，WKWebView 没有测试。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/19/2014summer/">2014 年终总结</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-19T01:09:20+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:09 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2014已经过去，先总结下去年的目标与主要的事：</h2>

<ul>
<li>一整年的工作，大部分都在做 iOS 开发，做了一些比较有成就感的东西，但是加班太多了，感觉好累好累，都没有时间思考，做一些自己感兴趣的事情；</li>
<li>写了一份移动设备上，快速回到顶部的专利；</li>
<li>优化了<a href="http://t.cn/zRAyu4l?u=1798492244&amp;m=3629415684524998&amp;cu=1798492244">Just Do it</a>这款 App，更新了几个版本，但是没做新应用，没有完成计划;</li>
<li>坚持写 blog，数了一下，原创的、翻译的，加起来刚好 12 篇，刚好完成目标;</li>
<li>宝宝终于开始熟练的会叫爸爸、妈妈、爷爷、奶奶、外婆了(就不会叫外公，估计是外公比较凶吧)，开始懂事了，模仿能力很强；比较惭愧，今年加班很多，较少时间陪他，陪他玩，和他在一起的时候我还经常拿着手机玩游戏……</li>
<li>加了一点工资，虽然没有达到期望，但还算不错；</li>
</ul>


<p>总得来说去年的目标完成得非常一般，在及格线附近……</p>

<h2>想想2015要做的</h2>

<ul>
<li>新年少加班，多充电学习，多陪陪家人；</li>
<li>多花点时间思考代码、架构，而不要纯写代码，完成业务；</li>
<li>写一份新专利；</li>
<li>努力当个好爸爸，多陪陪儿子，自己的一些坏习惯也要改下，比如老是在他面前玩手机，不怎么做家务等；给儿子树立良好的榜样；</li>
<li>带老婆出国旅游一次；</li>
<li>多写技术文章与总结，一年至少12篇；</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/17/oc-method-swizzling/">Objective-C Method Swizzling</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-09-17T22:36:40+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:36 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Objective-C 中的 Method Swizzling 是一种可以在程序运行时，修改方法调用的技术。是 OC 作为动态语言的典型证明。</p>

<p>Method Swizzling 是 OC <code>&lt;objc/runtime.h&gt;</code> 类库提供的“黑魔法”之一。</p>

<h2>例子</h2>

<p>以替换 NSArray 的 lastObject 方法为例：</p>

<ul>
<li>在 NSArray 中添加需要替换 lastObject 的方法 - xxx_lastObject方法：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#import &quot;NSArray+Swizzle.h&quot;  </span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="bp">NSArray</span> <span class="nl">(Swizzle)</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">xxx_lastObject</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">id</span> <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">xxx_lastObject</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;**********  myLastObject ***********&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意这里的写法，xxx_lastObject 方法的方法体中调用了 [self xxx_lastObject]，这样写并不会造成递归，后面会交换 xxx_lastObject 与 lastObject 的 IMP，其实 [self xxx_lastObject] 将会执行 [self lastObject] 。</p>

<ul>
<li>调换 IMP</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#import &lt;objc/runtime.h&gt;  </span>
</span><span class='line'><span class="cp">#import &quot;NSArray+Swizzle.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">Method</span> <span class="n">ori_Method</span> <span class="o">=</span>  <span class="n">class_getInstanceMethod</span><span class="p">([</span><span class="bp">NSArray</span> <span class="k">class</span><span class="p">],</span> <span class="k">@selector</span><span class="p">(</span><span class="n">lastObject</span><span class="p">));</span>
</span><span class='line'><span class="n">Method</span> <span class="n">my_Method</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">([</span><span class="bp">NSArray</span> <span class="k">class</span><span class="p">],</span> <span class="k">@selector</span><span class="p">(</span><span class="n">xxx_lastObject</span><span class="p">));</span>
</span><span class='line'><span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">ori_Method</span><span class="p">,</span> <span class="n">my_Method</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意这里需要引入 <code>&lt;objc/runtime.h&gt;</code>，否则会报错，因为使用了 runtime 中的 method_exchangeImplementations 方法。</p>

<p>使用 <code>method_exchangeImplementations</code> 交换了 xxx_lastObject 与 lastObject 的 IMP。后面会讲解更深层次的原理。</p>

<ul>
<li>尝试调用 lastObject</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#import &lt;objc/runtime.h&gt;</span>
</span><span class='line'><span class="cp">#import &quot;NSArray+Swizzle.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="bp">NSArray</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="l">@[</span><span class="s">@&quot;0&quot;</span><span class="p">,</span><span class="s">@&quot;1&quot;</span><span class="p">,</span><span class="s">@&quot;2&quot;</span><span class="p">,</span><span class="s">@&quot;3&quot;</span><span class="l">]</span><span class="p">;</span>
</span><span class='line'><span class="bp">NSString</span> <span class="o">*</span><span class="n">string</span> <span class="o">=</span> <span class="p">[</span><span class="n">array</span> <span class="n">lastObject</span><span class="p">];</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;TEST RESULT : %@&quot;</span><span class="p">,</span><span class="n">string</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出结果为:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="o">**********</span>  <span class="n">myLastObject</span> <span class="o">***********</span>
</span><span class='line'><span class="n">TEST</span> <span class="nl">RESULT</span> <span class="p">:</span> <span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>


<p>很明显，这里调用 lastObject 方法，其实是调用了我们添加的 xxx_lastObject 方法。</p>

<h2>用处</h2>

<p>Method Swizzling 非常强大，主要作用有：</p>

<ul>
<li>在不修改 iOS 系统类库或第三方类库的源码基础上，修改原有调用逻辑</li>
<li>动态添加、修改方法，修复线上 bug（如果 Apple 官方允许的话）</li>
</ul>


<h2>常用 API</h2>

<p>相关常用方法，都在<code>&lt;objc/runtime.h&gt;</code>包内：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">//向类中添加Method</span>
</span><span class='line'><span class="kt">BOOL</span> <span class="nf">class_addMethod</span><span class="p">(</span><span class="kt">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="kt">SEL</span> <span class="n">name</span><span class="p">,</span> <span class="kt">IMP</span> <span class="n">imp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">types</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//修改类的Method</span>
</span><span class='line'><span class="kt">IMP</span> <span class="n">class_replaceMethod</span><span class="p">(</span><span class="kt">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="kt">SEL</span> <span class="n">name</span><span class="p">,</span> <span class="kt">IMP</span> <span class="n">imp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">types</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//交换2个方法中的IMP</span>
</span><span class='line'><span class="kt">void</span> <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">Method</span> <span class="n">m1</span><span class="p">,</span> <span class="n">Method</span> <span class="n">m2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//获取类的某个实例方法</span>
</span><span class='line'><span class="n">Method</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="kt">Class</span> <span class="n">aClass</span><span class="p">,</span> <span class="kt">SEL</span> <span class="n">aSelector</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>底层原理</h2>

<p>在运行时，OC 的方法是一种叫 <code>Method</code> 的结构体，这种 <code>objc_method</code> 类型的结构体定义为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">struct</span> <span class="n">objc_method</span>
</span><span class='line'>   <span class="kt">SEL</span> <span class="n">method_name</span>         <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">char</span> <span class="o">*</span><span class="n">method_types</span>      <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">IMP</span> <span class="n">method_imp</span>          <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>method_name 是方法的 selector，可以理解为运行时的方法名；</li>
<li>*method_types 是一个参数和返回值类型<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html">编码</a>的字符串；</li>
<li>method_imp 是指向方法实现的指针。</li>
</ul>


<p><code>Method Swizzling 的实质是在运行时，访问对象的方法结构体，并改变它的底层实现。</code></p>

<p>我们以上节修改 NSArray 的 lastObject 为例做说明。</p>

<ul>
<li>初始时，lastObject 与 xxx_lastObject 方法的 Method 结构体：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">Method</span> <span class="n">lastObject</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">SEL</span> <span class="n">method_name</span> <span class="o">=</span> <span class="k">@selector</span><span class="p">(</span><span class="n">lastObject</span><span class="p">)</span>
</span><span class='line'>      <span class="kt">char</span> <span class="o">*</span><span class="n">method_types</span> <span class="o">=</span> <span class="err">“</span><span class="n">v</span><span class="p">@</span><span class="o">:</span><span class="err">“</span> <span class="c1">//返回值void, 参数id(self)，selector(_cmd)</span>
</span><span class='line'>      <span class="kt">IMP</span> <span class="n">method_imp</span> <span class="o">=</span> <span class="mh">0x000FFFF</span> <span class="c1">//指向([NSArray lastObject])</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Method</span> <span class="n">xxx_lastObject</span> <span class="p">{</span>
</span><span class='line'>       <span class="kt">SEL</span> <span class="n">method_name</span> <span class="o">=</span> <span class="k">@selector</span><span class="p">(</span><span class="n">swizzle_originalMethodName</span><span class="p">)</span>
</span><span class='line'>       <span class="kt">char</span> <span class="o">*</span><span class="n">method_types</span> <span class="o">=</span> <span class="err">“</span><span class="n">v</span><span class="p">@</span><span class="o">:</span><span class="err">”</span>
</span><span class='line'>       <span class="kt">IMP</span> <span class="n">method_imp</span> <span class="o">=</span> <span class="mh">0x1234AABA</span> <span class="c1">//指向([NSArray xxx_lastObject])</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>调用 <code>void method_exchangeImplementations(Method m1, Method m2)</code> ,交换两者的实现：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">Method</span> <span class="n">ori_Method</span> <span class="o">=</span>  <span class="n">class_getInstanceMethod</span><span class="p">([</span><span class="bp">NSArray</span> <span class="k">class</span><span class="p">],</span> <span class="k">@selector</span><span class="p">(</span><span class="n">lastObject</span><span class="p">));</span>
</span><span class='line'><span class="n">Method</span> <span class="n">my_Method</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">([</span><span class="bp">NSArray</span> <span class="k">class</span><span class="p">],</span> <span class="k">@selector</span><span class="p">(</span><span class="n">xxx_lastObject</span><span class="p">));</span>
</span><span class='line'><span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">ori_Method</span><span class="p">,</span> <span class="n">my_Method</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>调换后的 Method 结构体：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">Method</span> <span class="n">lastObject</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">SEL</span> <span class="n">method_name</span> <span class="o">=</span> <span class="k">@selector</span><span class="p">(</span><span class="n">lastObject</span><span class="p">)</span>
</span><span class='line'>      <span class="kt">char</span> <span class="o">*</span><span class="n">method_types</span> <span class="o">=</span> <span class="err">“</span><span class="p">@@</span><span class="o">:</span><span class="err">“</span> <span class="c1">//返回值id, 参数id(self)，selector(_cmd)</span>
</span><span class='line'>      <span class="kt">IMP</span> <span class="n">method_imp</span> <span class="o">=</span> <span class="mh">0x1234AABA</span> <span class="c1">//指向([NSArray xxx_lastObject])</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Method</span> <span class="n">xxx_lastObject</span> <span class="p">{</span>
</span><span class='line'>       <span class="kt">SEL</span> <span class="n">method_name</span> <span class="o">=</span> <span class="k">@selector</span><span class="p">(</span><span class="n">swizzle_originalMethodName</span><span class="p">)</span>
</span><span class='line'>       <span class="kt">char</span> <span class="o">*</span><span class="n">method_types</span> <span class="o">=</span> <span class="err">“</span><span class="p">@@</span><span class="o">:</span><span class="err">”</span>
</span><span class='line'>       <span class="kt">IMP</span> <span class="n">method_imp</span> <span class="o">=</span> <span class="mh">0x000FFFF</span> <span class="c1">//指向([NSArray lastObject])</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到使用<code>void method_exchangeImplementations(Method m1, Method m2)</code>的实质是交换了xxx_lastObject 与 lastObject 的 IMP，实现了在运行时做方法的替换。使得当执行 [array lastObject] 的时候，实际会去执行 [array xxx_lastObject] 的方法实现。</p>

<h2>其他提示</h2>

<h3>+load</h3>

<p>Swizzling 的处理，在类的 <code>+load</code> 方法中完成。</p>

<p>因为 <code>+load</code> 方法会在类被添加到 OC 运行时执行，且只会被调用一次，保证了 Swizzling 方法的及时处理。</p>

<h3>dispatch_once</h3>

<p>Swizzling 的处理，<code>dispatch_once</code> 中完成。保证只执行一次。</p>

<h3>prefix</h3>

<p>Swizzling 方法添加前缀，避免方法名称冲突。</p>

<h2>代码示例</h2>

<p><a href="https://github.com/sjpsega/SwizzleTest">代码示例</a></p>

<h2>参考资料</h2>

<p><a href="http://nshipster.com/method-swizzling/">Method Swizzling</a></p>

<p><a href="http://stackoverflow.com/questions/3267506/how-to-swizzle-a-class-method-on-ios">How to swizzle a class method on iOS?</a></p>

<p><a href="http://www.friday.com/bbum/2011/03/17/ios-4-3-imp_implementationwithblock/">iOS 4.3: imp_implementationWithBlock()</a></p>

<p><a href="http://blog.csdn.net/yiyaaixuexi/article/details/9374411">Objective-C的hook方案（一）:  Method Swizzling</a></p>

<p><a href="http://blog.jobbole.com/45963/">Objective-C 的动态提示和技巧</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/06/ios-h5-trap/">iOS H5的那些坑</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-08-06T17:47:30+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>5:47 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近做 iOS H5 项目，需要针对 iOS 的 webView 做适配，发现几个非常恶心的 bug。</p>

<p>因为现在据统计 iOS7 的占比超过80%，所以适配主要针对 iOS7，但是 iOS7 不同版本缺有不同的 bug，真是让人蛋疼。</p>

<h2>iOS 7.0 input 元素聚焦问题</h2>

<h3>bug 演示</h3>

<p><img src="/images/2014-08-06-ios-h5-trap/ios7.0bug.gif" alt="ios7.0bug.gif" /></p>

<h3>bug 分析</h3>

<p>点击屏幕下方的input元素，且该元素在键盘弹起的区域内；当键盘弹起时，input 元素未获得焦点，且 input 元素不在可视范围内，没有进行自动定位调整。</p>

<p>但 input 元素不在键盘弹起的区域内，当键盘弹起时，一切正常。</p>

<p>该 bug，iOS &lt; 7.1 有问题，>=7.1 无问题。</p>

<h3>解决办法</h3>

<p>办法有点猥琐，要通过 js，去强制 input 元素获得焦点。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">element</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;tap&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">element</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>参考资料</h3>

<p><a href="http://stackoverflow.com/questions/16149083/keyboardshrinksview-makes-lose-focus">KeyboardShrinksView makes lose focus</a></p>

<p><a href="https://issues.apache.org/jira/browse/CB-6974">Keyboard causes input focus issue</a></p>

<h2>iOS 7.1 input 元素失焦问题</h2>

<h3>bug 演示</h3>

<p><img src="/images/2014-08-06-ios-h5-trap/ios7.1bug.gif" alt="ios7.1bug.gif" /></p>

<h3>bug 分析</h3>

<p>点击 input 元素（input 元素在不在浮层中不重要），弹出键盘时，当点击 Html 中的元素，致使 input 元素失去焦点，键盘收起，position:fixed 元素（演示中的浮层为 position:fixed）会导致界面错乱。</p>

<p>但若点击键盘右上角的 <code>完成</code> 按钮，键盘收起，一切正常。</p>

<p>也就是说，使用 iOS 系统的方式使得键盘收起，没有问题；使用其他方式，使得键盘收起，position:fixed 元素会导致界面错乱。</p>

<p>该 bug，iOS >= 7.1 有问题，&lt; 7.1 无问题。正好与iOS 7.0 input 元素聚焦 bug 的情况相反。</p>

<p><code>注：iOS 键盘的操作，必须由用户的操作引发，想通过 JSBridge 去让键盘收起的方案是行不通的。</code></p>

<h3>解决办法</h3>

<p>避免使用 position:fixed，换成 position:absolute 替代。</p>

<h3>参考资料</h3>

<p><a href="http://stackoverflow.com/questions/18970865/ios-7-input-elements-moving-fixed-positioned-elements">ios-7-input-elements-moving-fixed-positioned-elements</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/02/first-china-joy/">我的第一次China Joy</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-08-02T15:01:40+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>3:01 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>昨天，刚好是扒衣见君节，我们一行9人去ChinaJoy。</p>

<p>这是我第一次去CJ，可开心啦！</p>

<h2>出发</h2>

<p>因为要一大早赶去上海，7点的火车，我离得比较近，坐地铁一站路，所以我6：25起床，坐地铁前往城站火车坐火车。</p>

<p>事实证明，我太自信了。</p>

<p>差不多6：50才到城站，因为是第一次坐地铁来城站坐火车，不熟悉地形。下了地铁，就一路小跑，跑进火车站。过了安检，看了火车的候车室，拔腿就跑，因为看到同事在微信里说，是第4站台，过了候车室的检票口，就径直跑去第4站台。结果傻眼了，第4站台没火车，看看其他站台有火车，但是看不到车次，此时已经是6：54。看看不对，立马跑回候车室，问检票员火车在第几站台，被告知在第1站台，拔腿就跑，看看车次是对的，算是松了一口气，再慢慢找车厢……差一点点误点啊……</p>

<h2>抵达</h2>

<p>到了上海，下了高铁，立马转地铁，前往离CJ场馆最近的站。上海的地铁真是方便，四通八达。</p>

<p>出了地铁，天已经下起了雨，还好带了伞。走了几步路，看到路边有CJ的接送车，问了下，居然是免费的，立马好感度倍增。</p>

<p>到了场馆门口，立马感受到了CJ的火爆，虽然天下着雨，但还是人山人海。大家有序地排队，很快就进去了。</p>

<p>场馆占地很大，进入场馆，我们起码又走了3个小场馆，才到了检票口。因为场馆网络的问题，我们买的又是支付宝的二维码票，所以检票也从简了，看一下就进去了。</p>

<h2>看游戏，还是看美女？</h2>

<p>进入展览场馆，立马会对来CJ是看游戏，还是看美女，这个问题产生思考。虽然之前看过报道，现在CJ也称<code>肉展</code>，都是推销美女，顺便推广游戏……今天来此一看，果然如此。</p>

<p>每个展台前，大家都把闪光灯对着美女，对展商推广的游戏视而不见。展商也顺应潮流，请了大把的美女，好多站台都是美女一字排开，才显气势。</p>

<p><img src="/images/2014-08-02-first-china-joy/cj-beauty-1.png" alt="cj-beauty-1" />
<img src="/images/2014-08-02-first-china-joy/cj-beauty-2.png" alt="cj-beauty-2" />
<img src="/images/2014-08-02-first-china-joy/cj-beauty-3.png" alt="cj-beauty-3" />
<img src="/images/2014-08-02-first-china-joy/cj-beauty-4.png" alt="cj-beauty-4" />
<img src="/images/2014-08-02-first-china-joy/cj-beauty-5.png" alt="cj-beauty-5" />
<img src="/images/2014-08-02-first-china-joy/cj-beauty-6.png" alt="cj-beauty-6" />
<img src="/images/2014-08-02-first-china-joy/cj-beauty-7.png" alt="cj-beauty-7" />
<img src="/images/2014-08-02-first-china-joy/cj-beauty-8.png" alt="cj-beauty-8" /></p>

<h2>CJ的最后希望</h2>

<p>还好，因为微软的XOne和索尼的PS4都要为进入中国市场造势，所以今年都参加了CJ，而且场面很大。还好有了微软和索尼，才能在CJ上看到一点游戏……</p>

<p><img src="/images/2014-08-02-first-china-joy/cj-ms-1.png" alt="cj-ms-1" />
<img src="/images/2014-08-02-first-china-joy/cj-ms-2.png" alt="cj-ms-2" />
<img src="/images/2014-08-02-first-china-joy/cj-sony-1.png" alt="cj-sony-1" />
<img src="/images/2014-08-02-first-china-joy/cj-sony-2.png" alt="cj-sony-2" />
<img src="/images/2014-08-02-first-china-joy/cj-sony-3.png" alt="cj-sony-3" />
<img src="/images/2014-08-02-first-china-joy/cj-sony-4.png" alt="cj-sony-4" /></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/3">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/index.html">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/09/15/910/">怒放的生命</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/22/kechuangban/">科创板</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/04/payout/">用错误的方法赚到钱，迟早要还</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/01/01/2018summary/">2018 年终总结</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/02/14/2017summary/">2017 年终总结</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>About Me</h1>
  <p>程序员</p>
  <p>技术经历：As -> Js -> iOS</p>
  <p>新浪微博：<a href="http://weibo.com/sjpsega">IORI_YAGAMI_7</a></p>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - sjpsega -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  









<!--cnzz统计-->
<script src="http://s13.cnzz.com/stat.php?id=5808684&web_id=5808684" language="JavaScript"></script>

</body>
</html>
