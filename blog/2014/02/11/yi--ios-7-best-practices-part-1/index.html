
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>[译]iOS7最佳实践：一个天气App案例(一) - sjpsega's Blog</title>
  <meta name="author" content="sjpsega">

  
  <meta name="description" content="注：本文译自：raywenderlich ios-7-best-practices-part-1，去除了跟主题无关的寒暄部分。
欢迎转载，保持署名 在这个两部分的系列教程中，您将探索如何使用以下工具和技术来创建自己的App： Cocoapods
Manual layout in code( &hellip;">
  <meta name="keywords" content="iOS7, Cocoapods, ReactiveCocoa, Mantle">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--友言验证-->
  <meta name="uyan_auth" content="7d2af41cee" />

  
  <link rel="canonical" href="http://sjpsega.me/blog/2014/02/11/yi--ios-7-best-practices-part-1/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="sjpsega's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/jquery.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts 
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->
  

  <script type="text/javascript">
  //链接新开窗口
  function addBlankTargetForLinks () {
      $('a[href^="http"]').each(function(){
          $(this).attr('target', '_blank');
      });
  }
  $(document).ready(function(event) {
      addBlankTargetForLinks();
  });
  </script>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">sjpsega's Blog</a></h1>
  
    <h2>记录我的生活与学习.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="sjpsega.me">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
  <li><a href="/blog/categories/study">学习</a></li>
  <li><a href="/blog/categories/life">生活</a></li>
  <li><a href="/blog/categories/invest">投资</a></li>
  <li><a href="http://weibo.com/sjpsega" target="_blank">我的微博</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">[译]iOS7最佳实践：一个天气App案例(一)</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-02-11T22:21:53+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:21 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>注：本文译自：<a href="http://www.raywenderlich.com/55384/ios-7-best-practices-part-1">raywenderlich ios-7-best-practices-part-1</a>，去除了跟主题无关的寒暄部分。
欢迎转载，保持署名</p>

<p>在这个两部分的系列教程中，您将探索如何使用以下工具和技术来创建自己的App：</p>

<ul>
<li><a href="http://cocoapods.org/">Cocoapods</a></li>
<li>Manual layout in code(纯代码布局)</li>
<li><a href="https://github.com/ReactiveCocoa/ReactiveCocoa">ReactiveCocoa</a></li>
<li><a href="http://openweathermap.org/">OpenWeatherMap</a></li>
</ul>


<p>本教程专为熟悉基本知识的、但还没有接触到太多高级主题的中级开发者而设计。本教程也是想要去探索Objective-C<a href="http://en.wikipedia.org/wiki/Functional_programming">函数编程</a>一个很好的开始。</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/weather3.gif" alt="Finished Weather App" /></p>

<h2>开始</h2>

<p>打开Xcode并执行<code>File\New\Project</code>。选择<code>Application\Empty Application</code>。将项目命名为<code>SimpleWeather</code>，单击下一步，选择一个目录去保存你的项目，然后点击Create。
现在，你的基础项目已经完成。下一步是集成你的第三方工具。但首先你要<code>关闭Xcode</code>，确保他不会影响下一步。</p>

<h3>Cocoapods</h3>

<p>你将要下载<a href="http://cocoapods.org/">Cocoapods</a>的代码，在Xcode项目中添加文件来使用，并配置项目需要的设置。</p>

<h3>Mantle</h3>

<p><a href="https://github.com/MantleFramework/Mantle">Mantle</a>是由于Github团队开发的，目的是去除Objective-C把JSON数据转为NSObject子类的所有样板代码。Mantle也能做数据转换，通过一种神奇的方式把JSON原始数据(strings, ints, floats)转换为复杂数据，比如NSDate, NSURL, 甚至是自定义类。</p>

<h3>LBBlurredImage</h3>

<p><a href="https://github.com/lukabernardi/LBBlurredImage">LBBlurredImage</a>是一个继承自UIImageView，轻而易举使图像模糊的项目。你将仅仅用一行代码来创建一个神奇的模糊效果。</p>

<h3>TSMessages</h3>

<p><a href="https://github.com/toursprung/TSMessages">TSMessages</a> 是另一个非常简单的库，用来显示浮层警告和通知。当出现错误信息而不直接影响用户的时候，最好使用浮层来代替模态窗口(例如UIAlertView)，这样你将尽可能减少对用户的影响。</p>

<p>你将只用TSMessages，在网络失去连接或API错误的时候。如果发生错误，你将看到类似这样的一个浮层：</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/12/TSMessage.png" alt="TSMessages Error" /></p>

<h3>ReactiveCocoa</h3>

<p>最后，你将使用到<a href="https://github.com/ReactiveCocoa/ReactiveCocoa">ReactiveCocoa</a>，他也来自于GitHub团队。ReactiveCocoa给Objective-C带来了函数编程，类似与.NET的<a href="http://msdn.microsoft.com/en-us/data/gg577609.aspx">Reactive Extensions</a>。你将在第二部分花费大部分时间去实现ReactiveCocoa。</p>

<h2>设置你的Cocoapods</h2>

<p>设置你的Cocoapods，先要确保你已经安装了Cocoapods。为此，打开命令行程序，并输入。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>which pod</span></code></pre></td></tr></table></div></figure>


<p>你将会看到类似这样的输出:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/pod</span></code></pre></td></tr></table></div></figure>


<p>这决定于你如何管理Ruby gems，例如你使用<a href="http://rbenv.org/">rbenv</a>或<a href="http://rvm.io/">RVM</a>,路径可能有所不同。</p>

<p>如果命令行简单的返回提示，或显示<code>pod not found</code>，表示Cocoapods未安装在你的机器上。可以查看我们的<a href="http://www.raywenderlich.com/12139/introduction-to-cocoapods">Cocoapods教程</a>作为安装说明。这也是一个很好的资源，如果你想更多得了解Cocoapods的话。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sjpsega注:Cocoapods中文安装教程可以看这篇 http://geeklu.com/2013/06/cocoapods-101/</span></code></pre></td></tr></table></div></figure>


<p><a href="http://guides.cocoapods.org/syntax/podfile.html">Podfiles</a>是用来告诉Cocoapods哪些开源项目需要导入。</p>

<p>要创建你的第一个Cocoapod，首先在命令行中用<code>cd</code>命令导航到你的XCode项目所在的文件夹，在命令行中启动编辑器，输入</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>platform :ios, '7.0'
</span><span class='line'> 
</span><span class='line'>pod 'Mantle'
</span><span class='line'>pod 'LBBlurredImage'
</span><span class='line'>pod 'TSMessages'
</span><span class='line'>pod 'ReactiveCocoa'</span></code></pre></td></tr></table></div></figure>


<p>这文件做了两件事情：</p>

<ul>
<li>告诉Cocoapods你的目标平台与版本，这里的你目标是iOS 7.0。</li>
<li>列给Cocoapods一个项目所有需要引入和安装的三方库清单。</li>
</ul>


<p>在命令行中输入<code>pod install</code>进行安装。</p>

<p>这可能需要花一到两分钟的时间去安装各种包。你的命令行应该输出如下所示:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pod install
</span><span class='line'>Analyzing dependencies
</span><span class='line'> 
</span><span class='line'>CocoaPods 0.28.0 is available.
</span><span class='line'> 
</span><span class='line'>Downloading dependencies
</span><span class='line'>Installing HexColors (2.2.1)
</span><span class='line'>Installing LBBlurredImage (0.1.0)
</span><span class='line'>Installing Mantle (1.3.1)
</span><span class='line'> 
</span><span class='line'>Installing ReactiveCocoa (2.1.7)
</span><span class='line'>Installing TSMessages (0.9.4)
</span><span class='line'>Generating Pods project
</span><span class='line'>Integrating client project
</span><span class='line'> 
</span><span class='line'>[!] From now on use `SimpleWeather.xcworkspace`.</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sjpsega注:若你之前安装过Cocoapods的话，这里安装报错的话，可以看看http://blog.cocoapods.org/Repairing-Our-Broken-Specs-Repository/ 修复问题</span></code></pre></td></tr></table></div></figure>


<p>Cocoapods会在你的项目目录中创建一堆新文件，但是，只有一个需要你关心，<code>SimpleWeather.xcworkspace</code>。</p>

<p>用Xcode打开<code>SimpleWeather.xcworkspace</code>。看看你的项目设置，现在有一个Pods项目在你的项目工作区，以及在Pods文件夹放着每一个你引入的库，如下所示：</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/12/SimpleWeather-Cocoapods.jpg" alt="Cocoapods Project" /></p>

<p>确保你已经选择SimpleWeather项目，如图所示：
<img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/12/SimpleWeather-Project.jpg" alt="Select SimpleWeather Project" /></p>

<p>构建并运行您的App，以确保一切工作正常：</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/blank-app.jpg" width="320" alt="Blank App" /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>提示：您可能会注意到有一些项目生成警告。因为Cocoapods引入的项目，是由不同的开发者开发，并且不同的开发者对生成警告有不同的态度。通常，你应该可以忽略它们。只要确保没有任何编译器错误！</span></code></pre></td></tr></table></div></figure>


<h2>创建你的主视图控制器</h2>

<p>虽然这个App看起来复杂，但它还会通过一个单一的View Controller完成。现在，你将添加他。</p>

<p>选中<code>SimpleWeather</code>项目，单击<code>File\New\File</code>，并且选择<code>Cocoa Touch\Objective-C class</code>. 命名为<code>WXController</code>，并设置为<code>UIViewController</code>的子类。</p>

<p>确保<code>Targeted for iPad</code>和<code>With XIB for user interface</code>都没有选中，如下图所示：
<img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/create-controller.jpg" alt="Create WXController" /></p>

<p>打开<code>WXController.m</code>然后用如下所示替换<code>-viewDidLoad</code>方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)viewDidLoad {
</span><span class='line'>    [super viewDidLoad];
</span><span class='line'> 
</span><span class='line'>    // Remove this later
</span><span class='line'>    self.view.backgroundColor = [UIColor redColor];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>现在打开<code>AppDelegate.m</code>，并且引入如下两个class:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#import "WXController.h"
</span><span class='line'>#import &lt;TSMessage.h&gt;</span></code></pre></td></tr></table></div></figure>


<p>眼尖的读者会注意到<code>WXController</code>使用引号引入，<code>TSMessage</code>使用单括号引入。</p>

<p>回头看下当你创建Podfile的时候，你使用Cocoapods引入<code>TSMessage</code>。Cocoapods创建TSMessage项目，并把它加入到工作空间。既然你从工作区的其他项目导入，可以使用尖括号代替引号。</p>

<p>代替<code>-application:didFinishLaunchingWithOptions</code>的内容：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
</span><span class='line'>    self.window = [[UIWindow alloc] initWithFrame:[[UIScreen mainScreen] bounds]];
</span><span class='line'>    // 1
</span><span class='line'>    self.window.rootViewController = [[WXController alloc] init];
</span><span class='line'>    self.window.backgroundColor = [UIColor whiteColor];
</span><span class='line'>    [self.window makeKeyAndVisible];
</span><span class='line'>    // 2
</span><span class='line'>    [TSMessage setDefaultViewController: self.window.rootViewController];
</span><span class='line'>    return YES;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>标号注释的解释：</p>

<ol>
<li>初始化并设置<code>WXController</code>实例作为App的根视图控制器。通常这个控制器是一个的<code>UINavigationController</code>或<code>UITabBarController</code>，但在当前情况下，你使用<code>WXController</code>的单个实例。</li>
<li>设置默认的视图控制器来显示你的TSMessages。这样做，你将不再需要手动指定要使用的控制器来显示警告。</li>
</ol>


<p>构建并运行，看看你的新视图控制器起作用了。</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/wxcontroller-red.jpg" width="320" alt="WXController" /></p>

<p>在红色背景下，状态栏有点不够清晰。幸运的是，有一个简单的方法，使状态栏更清晰易读。</p>

<p>在iOS7，<a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIViewController_Class/Reference/Reference.html#//apple_ref/occ/instm/UIViewController/preferredStatusBarStyle">UIViewController</a>有一个新的API，用来控制状态栏的外观。打开<code>WXController</code>，直接添加下面的代码到<code>-viewDidLoad:</code>方法下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (UIStatusBarStyle)preferredStatusBarStyle {
</span><span class='line'>    return UIStatusBarStyleLightContent;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>再次构建并运行，你将看到状态栏如下的变化:</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/wxcontroller-red-status.jpg" width="320" alt="Create WXController with Light Status Bar" /></p>

<h2>设置你的App视图</h2>

<p>现在是时候让你的App接近生活。下载这个项目的<a href="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/Images.zip">图片</a>，并解压缩到一个合适的位置。这个压缩包的背景图片出自Flickr用户<a href="http://www.flickr.com/photos/52547323@N00/5637648252">idleformat</a>之手，天气图片出自Dribbble用户<a href="http://dribbble.com/shots/1247177-Weather-icons?list=users">heeyeun</a>之手。</p>

<p>切换回Xcode，单击<code>File\Add Files to “SimpleWeather”</code>&hellip;.定位到你刚刚解压缩的图片文件夹并选择它。选择<code>Copy items into destination group’s folder (if needed)</code>，然后单击<code>Add</code>。</p>

<p>打开<code>WXController.h</code>, 添加如下委托协议：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;UITableViewDataSource, UITableViewDelegate, UIScrollViewDelegate&gt;</span></code></pre></td></tr></table></div></figure>


<p>现在打开<code>WXController.m</code>。 小提示：你可以使用<code>Control-Command-Up</code>的快捷键来实现<code>.h</code>和<code>.m</code>文件之间的快速切换。</p>

<p>添加如下代码到<code>WXController.m</code>顶部:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#import &lt;LBBlurredImage/UIImageView+LBBlurredImage.h&gt;</span></code></pre></td></tr></table></div></figure>


<p><code>LBBlurredImage.h</code>包含在Cocoapods引入的<code>LBBlurredImage</code>项目，你会使用这个库来模糊背景图片。</p>

<p>应该有一个空的私有接口样板在<code>WXController</code> imports的下方。它具有以下属性：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@interface WXController ()
</span><span class='line'> 
</span><span class='line'>@property (nonatomic, strong) UIImageView *backgroundImageView;
</span><span class='line'>@property (nonatomic, strong) UIImageView *blurredImageView;
</span><span class='line'>@property (nonatomic, strong) UITableView *tableView;
</span><span class='line'>@property (nonatomic, assign) CGFloat screenHeight;
</span><span class='line'> 
</span><span class='line'>@end</span></code></pre></td></tr></table></div></figure>


<p>现在，是时候在项目中创建并设置视图。</p>

<p>下面是你App的分解图，记住，table view将是透明的：</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/screens.jpg" alt="Exploded Screens" /></p>

<p>为了实现动态模糊效果，在你的App中，你会根据App的滚动来改变模糊图像的alpha值。</p>

<p>打开<code>WXController.m</code>，使用如下代码来，替换掉<code>-viewDidLoad</code>中设置背景色的代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1
</span><span class='line'>self.screenHeight = [UIScreen mainScreen].bounds.size.height;
</span><span class='line'> 
</span><span class='line'>UIImage *background = [UIImage imageNamed:@"bg"];
</span><span class='line'> 
</span><span class='line'>// 2
</span><span class='line'>self.backgroundImageView = [[UIImageView alloc] initWithImage:background];
</span><span class='line'>self.backgroundImageView.contentMode = UIViewContentModeScaleAspectFill;
</span><span class='line'>[self.view addSubview:self.backgroundImageView];
</span><span class='line'> 
</span><span class='line'>// 3
</span><span class='line'>self.blurredImageView = [[UIImageView alloc] init];
</span><span class='line'>self.blurredImageView.contentMode = UIViewContentModeScaleAspectFill;
</span><span class='line'>self.blurredImageView.alpha = 0;
</span><span class='line'>[self.blurredImageView setImageToBlur:background blurRadius:10 completionBlock:nil];
</span><span class='line'>[self.view addSubview:self.blurredImageView];
</span><span class='line'> 
</span><span class='line'>// 4
</span><span class='line'>self.tableView = [[UITableView alloc] init];
</span><span class='line'>self.tableView.backgroundColor = [UIColor clearColor];
</span><span class='line'>self.tableView.delegate = self;
</span><span class='line'>self.tableView.dataSource = self;
</span><span class='line'>self.tableView.separatorColor = [UIColor colorWithWhite:1 alpha:0.2];
</span><span class='line'>self.tableView.pagingEnabled = YES;
</span><span class='line'>[self.view addSubview:self.tableView];</span></code></pre></td></tr></table></div></figure>


<p>这是非常简单的代码：</p>

<ol>
<li>获取并存储屏幕高度。之后，你将在用分页的方式来显示所有天气​​数据时，使用它。</li>
<li>创建一个静态的背景图，并添加到视图上。</li>
<li>使用LBBlurredImage来创建一个模糊的背景图像，并设置alpha为0，使得开始<code>backgroundImageView</code>是可见的。</li>
<li>创建tableview来处理所有的数据呈现。 设置WXController为delegate和dataSource，以及滚动视图的delegate。请注意，设置<code>pagingEnabled</code>为<code>YES</code>。</li>
</ol>


<p>添加如下UITableView的delegate和dataSource的代码到<code>WXController.m</code>的<code>@implementation</code>块中：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1
</span><span class='line'>#pragma mark - UITableViewDataSource
</span><span class='line'> 
</span><span class='line'>// 2
</span><span class='line'>- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {
</span><span class='line'>    return 2;
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
</span><span class='line'>    // TODO: Return count of forecast
</span><span class='line'>    return 0;
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
</span><span class='line'>    static NSString *CellIdentifier = @"CellIdentifier";
</span><span class='line'>    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:CellIdentifier];
</span><span class='line'> 
</span><span class='line'>    if (! cell) {
</span><span class='line'>        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleValue1 reuseIdentifier:CellIdentifier];
</span><span class='line'>    }
</span><span class='line'> 
</span><span class='line'>    // 3
</span><span class='line'>    cell.selectionStyle = UITableViewCellSelectionStyleNone;
</span><span class='line'>    cell.backgroundColor = [UIColor colorWithWhite:0 alpha:0.2];
</span><span class='line'>    cell.textLabel.textColor = [UIColor whiteColor];
</span><span class='line'>    cell.detailTextLabel.textColor = [UIColor whiteColor];
</span><span class='line'> 
</span><span class='line'>    // TODO: Setup the cell
</span><span class='line'> 
</span><span class='line'>    return cell;
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>#pragma mark - UITableViewDelegate
</span><span class='line'> 
</span><span class='line'>- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath {
</span><span class='line'>    // TODO: Determine cell height based on screen
</span><span class='line'>    return 44;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ol>
<li><code>Pragma mark</code>是<a href="http://nshipster.com/pragma/">组织代码</a>的很好的一种方式。</li>
<li>你的table view有两个部分，一个是每小时的天气预报，另一个用于每日播报。table view的section数目，设置为2。</li>
<li>天气预报的cell是不可选择的。给他们一个半透明的黑色背景和白色文字。</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>注意：使用格式化的注释 // TODO：可以帮助Xcode找到需要以后完成的代码。你还可以使用 Show Document Items(Control-6)来查看TODO项。</span></code></pre></td></tr></table></div></figure>


<p>最后，添加如下代码到<code>WXController.m</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)viewWillLayoutSubviews {
</span><span class='line'>    [super viewWillLayoutSubviews];
</span><span class='line'> 
</span><span class='line'>    CGRect bounds = self.view.bounds;
</span><span class='line'> 
</span><span class='line'>    self.backgroundImageView.frame = bounds;
</span><span class='line'>    self.blurredImageView.frame = bounds;
</span><span class='line'>    self.tableView.frame = bounds;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>在<code>WXController.m</code>中，你的视图控制器调用该方法来编排其子视图。</p>

<p>构建并运行你的App，看看你的视图如何堆叠。</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/background.jpg" width="320" alt="Image Background" /></p>

<p>仔细看，你会看到所有空的table cell的cell分隔线。</p>

<p>仍然在<code>-viewDidLoad</code>中，添加下面的代码来设置你的布局框架和边距：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1
</span><span class='line'>CGRect headerFrame = [UIScreen mainScreen].bounds;
</span><span class='line'>// 2
</span><span class='line'>CGFloat inset = 20;
</span><span class='line'>// 3
</span><span class='line'>CGFloat temperatureHeight = 110;
</span><span class='line'>CGFloat hiloHeight = 40;
</span><span class='line'>CGFloat iconHeight = 30;
</span><span class='line'>// 4
</span><span class='line'>CGRect hiloFrame = CGRectMake(inset, 
</span><span class='line'>                              headerFrame.size.height - hiloHeight,
</span><span class='line'>                              headerFrame.size.width - (2 * inset),
</span><span class='line'>                              hiloHeight);
</span><span class='line'> 
</span><span class='line'>CGRect temperatureFrame = CGRectMake(inset, 
</span><span class='line'>                                     headerFrame.size.height - (temperatureHeight + hiloHeight),
</span><span class='line'>                                     headerFrame.size.width - (2 * inset),
</span><span class='line'>                                     temperatureHeight);
</span><span class='line'> 
</span><span class='line'>CGRect iconFrame = CGRectMake(inset, 
</span><span class='line'>                              temperatureFrame.origin.y - iconHeight, 
</span><span class='line'>                              iconHeight, 
</span><span class='line'>                              iconHeight);
</span><span class='line'>// 5
</span><span class='line'>CGRect conditionsFrame = iconFrame;
</span><span class='line'>conditionsFrame.size.width = self.view.bounds.size.width - (((2 * inset) + iconHeight) + 10);
</span><span class='line'>conditionsFrame.origin.x = iconFrame.origin.x + (iconHeight + 10);</span></code></pre></td></tr></table></div></figure>


<p>这是相当常规设置代码，但这里是怎么回事：</p>

<ol>
<li>设置table的header大小与屏幕相同。你将利用的UITableView的分页来分隔页面页头和每日每时的天气预报部分。</li>
<li>创建inset（或padding）变量，以便您的所有标签均匀分布并居中。</li>
<li>创建并初始化为各种视图创建的高度变量。设置这些值作为常量，使得可以很容易地在需要的时候，配置和更改您的视图设置。</li>
<li>使用常量和inset变量，为label和view创建框架。</li>
<li>复制图标框，调整它，使文本具有一定的扩展空间，并将其移动到该图标的右侧。当我们把标签添加到视图，你会看到布局的效果。</li>
</ol>


<p>添加如下代码到<code>-viewDidLoad</code>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1
</span><span class='line'>UIView *header = [[UIView alloc] initWithFrame:headerFrame];
</span><span class='line'>header.backgroundColor = [UIColor clearColor];
</span><span class='line'>self.tableView.tableHeaderView = header;
</span><span class='line'> 
</span><span class='line'>// 2
</span><span class='line'>// bottom left
</span><span class='line'>UILabel *temperatureLabel = [[UILabel alloc] initWithFrame:temperatureFrame];
</span><span class='line'>temperatureLabel.backgroundColor = [UIColor clearColor];
</span><span class='line'>temperatureLabel.textColor = [UIColor whiteColor];
</span><span class='line'>temperatureLabel.text = @"0°";
</span><span class='line'>temperatureLabel.font = [UIFont fontWithName:@"HelveticaNeue-UltraLight" size:120];
</span><span class='line'>[header addSubview:temperatureLabel];
</span><span class='line'> 
</span><span class='line'>// bottom left
</span><span class='line'>UILabel *hiloLabel = [[UILabel alloc] initWithFrame:hiloFrame];
</span><span class='line'>hiloLabel.backgroundColor = [UIColor clearColor];
</span><span class='line'>hiloLabel.textColor = [UIColor whiteColor];
</span><span class='line'>hiloLabel.text = @"0° / 0°";
</span><span class='line'>hiloLabel.font = [UIFont fontWithName:@"HelveticaNeue-Light" size:28];
</span><span class='line'>[header addSubview:hiloLabel];
</span><span class='line'> 
</span><span class='line'>// top
</span><span class='line'>UILabel *cityLabel = [[UILabel alloc] initWithFrame:CGRectMake(0, 20, self.view.bounds.size.width, 30)];
</span><span class='line'>cityLabel.backgroundColor = [UIColor clearColor];
</span><span class='line'>cityLabel.textColor = [UIColor whiteColor];
</span><span class='line'>cityLabel.text = @"Loading...";
</span><span class='line'>cityLabel.font = [UIFont fontWithName:@"HelveticaNeue-Light" size:18];
</span><span class='line'>cityLabel.textAlignment = NSTextAlignmentCenter;
</span><span class='line'>[header addSubview:cityLabel];
</span><span class='line'> 
</span><span class='line'>UILabel *conditionsLabel = [[UILabel alloc] initWithFrame:conditionsFrame];
</span><span class='line'>conditionsLabel.backgroundColor = [UIColor clearColor];
</span><span class='line'>conditionsLabel.font = [UIFont fontWithName:@"HelveticaNeue-Light" size:18];
</span><span class='line'>conditionsLabel.textColor = [UIColor whiteColor];
</span><span class='line'>[header addSubview:conditionsLabel];
</span><span class='line'> 
</span><span class='line'>// 3
</span><span class='line'>// bottom left
</span><span class='line'>UIImageView *iconView = [[UIImageView alloc] initWithFrame:iconFrame];
</span><span class='line'>iconView.contentMode = UIViewContentModeScaleAspectFit;
</span><span class='line'>iconView.backgroundColor = [UIColor clearColor];
</span><span class='line'>[header addSubview:iconView];</span></code></pre></td></tr></table></div></figure>


<p>这是相当长的一块代码，但它真的只是在做设置各种控件的繁重工作。简单的说：</p>

<ol>
<li>设置当前view为你的table header。</li>
<li>构建每一个显示气象数据的标签。</li>
<li>添加一个天气图标的图像视图。</li>
</ol>


<p>构建并运行你的App，你应该可以看到你之前布局的所有所有view。下面的屏幕截图显示了使用手工布局的、所有标签框在视觉上的显示。</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/12/built-layout.jpg" width="500" alt="Labels and Views" /></p>

<p>用手指轻轻推动table，当你滚动它的时候，应该会反弹。</p>

<h2>获取气象数据</h2>

<p>你会注意到，App显示“Loading&hellip;”，但它不是真正地在工作。是时候获取一些真正的天气数据。</p>

<p>你会从<a href="http://openweathermap.org/">OpenWeatherMap</a>的API拉取数据。 OpenWeatherMap是一个非常棒的服务，旨在提供实时，准确，免费的天气数据给任何人。虽然有很多天气API，但他们大多要么使用较旧的数据格式，如XML，或是有偿服务 - 并且有时还相当昂贵。</p>

<p>你会遵循以下基本步骤，来获你设备的位置的气象数据：</p>

<ol>
<li>找到设备的位置</li>
<li>从<a href="http://api.openweathermap.org/data/2.5/weather?lat=37.785834&amp;lon=-122.406417&amp;units=imperial">API端</a>下载JSON数据</li>
<li>映射JSON到<code>WXConditions</code>和<code>WXDailyForecasts</code></li>
<li>告诉UI有新数据了</li>
</ol>


<p>开始创建你的天气模型和数据管理类。单击<code>File\New\File…</code>并选择<code>Cocoa Touch\Objective-C class</code>。命名为<code>WXClient</code>并使其为<code>NSObject</code>的子类。</p>

<p>这样再做三次创建以下类：</p>

<ul>
<li><code>WXManager</code>作为<code>NSObject</code>的子类</li>
<li><code>WXCondition</code>作为<code>MTLModel</code>的子类</li>
<li><code>WXDailyForecast</code>作为<code>WXCondition</code>的子类</li>
</ul>


<p>全部完成？现在，你可以开始下一节，其中涉及映射和转换您的天气数据。</p>

<h2>创建你的天气模型</h2>

<p>你的模型将使用<a href="https://github.com/github/Mantle">Mantle</a>，这使得数据映射和转型非常简单。</p>

<p>打开<code>WXCondition.h</code>如下列代码，修改接口：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1
</span><span class='line'>@interface WXCondition : MTLModel &lt;MTLJSONSerializing&gt;
</span><span class='line'> 
</span><span class='line'>// 2
</span><span class='line'>@property (nonatomic, strong) NSDate *date;
</span><span class='line'>@property (nonatomic, strong) NSNumber *humidity;
</span><span class='line'>@property (nonatomic, strong) NSNumber *temperature;
</span><span class='line'>@property (nonatomic, strong) NSNumber *tempHigh;
</span><span class='line'>@property (nonatomic, strong) NSNumber *tempLow;
</span><span class='line'>@property (nonatomic, strong) NSString *locationName;
</span><span class='line'>@property (nonatomic, strong) NSDate *sunrise;
</span><span class='line'>@property (nonatomic, strong) NSDate *sunset;
</span><span class='line'>@property (nonatomic, strong) NSString *conditionDescription;
</span><span class='line'>@property (nonatomic, strong) NSString *condition;
</span><span class='line'>@property (nonatomic, strong) NSNumber *windBearing;
</span><span class='line'>@property (nonatomic, strong) NSNumber *windSpeed;
</span><span class='line'>@property (nonatomic, strong) NSString *icon;
</span><span class='line'> 
</span><span class='line'>// 3
</span><span class='line'>- (NSString *)imageName;
</span><span class='line'> 
</span><span class='line'>@end</span></code></pre></td></tr></table></div></figure>


<ol>
<li><code>MTLJSONSerializing</code>协议告诉Mantle序列化该对象如何从JSON映射到Objective-C的属性。</li>
<li>这些都是你的天气数据的属性。你将会使用这些属性的get set方法，但是当你要扩展App，这是一种很好的方法来访问数据。</li>
<li>这是一个简单的辅助方法，从天气状况映射到图像文件。</li>
</ol>


<p>构建并运行App。失败了……</p>

<p>原因是你没有从你的Cocoapods项目中引入<code>Mantle</code>。解决方法是，在<code>WXCondition.h</code>中，你需要把<code>MTLModel.h</code>替换为<code>#import &lt;Mantle.h&gt;</code>。</p>

<p>现在构建并运行App。成功了。你会看到一些新的警告，但你可以忽略他们。</p>

<p>首先，你需要处理未实现的<code>-imageName</code>方法。</p>

<p>打开<code>WXCondition.m</code>，添加如下方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (NSDictionary *)imageMap {
</span><span class='line'>    // 1
</span><span class='line'>    static NSDictionary *_imageMap = nil;
</span><span class='line'>    if (! _imageMap) {
</span><span class='line'>        // 2
</span><span class='line'>        _imageMap = @{
</span><span class='line'>                      @"01d" : @"weather-clear",
</span><span class='line'>                      @"02d" : @"weather-few",
</span><span class='line'>                      @"03d" : @"weather-few",
</span><span class='line'>                      @"04d" : @"weather-broken",
</span><span class='line'>                      @"09d" : @"weather-shower",
</span><span class='line'>                      @"10d" : @"weather-rain",
</span><span class='line'>                      @"11d" : @"weather-tstorm",
</span><span class='line'>                      @"13d" : @"weather-snow",
</span><span class='line'>                      @"50d" : @"weather-mist",
</span><span class='line'>                      @"01n" : @"weather-moon",
</span><span class='line'>                      @"02n" : @"weather-few-night",
</span><span class='line'>                      @"03n" : @"weather-few-night",
</span><span class='line'>                      @"04n" : @"weather-broken",
</span><span class='line'>                      @"09n" : @"weather-shower",
</span><span class='line'>                      @"10n" : @"weather-rain-night",
</span><span class='line'>                      @"11n" : @"weather-tstorm",
</span><span class='line'>                      @"13n" : @"weather-snow",
</span><span class='line'>                      @"50n" : @"weather-mist",
</span><span class='line'>                      };
</span><span class='line'>    }
</span><span class='line'>    return _imageMap;
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>// 3
</span><span class='line'>- (NSString *)imageName {
</span><span class='line'>    return [WXCondition imageMap][self.icon];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ol>
<li>创建一个静态的NSDictionary，因为WXCondition的每个实例都将使用相同的数据映射。</li>
<li>天气状况与图像文件的关系（例如“01d”代表“weather-clear.png”）。</li>
<li>声明获取图像文件名的公有方法。</li>
</ol>


<p>看一看从OpenWeatherMap返回的JSON响应数据：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>    "dt": 1384279857,
</span><span class='line'>    "id": 5391959,
</span><span class='line'>    "main": {
</span><span class='line'>        "humidity": 69,
</span><span class='line'>        "pressure": 1025,
</span><span class='line'>        "temp": 62.29,
</span><span class='line'>        "temp_max": 69.01,
</span><span class='line'>        "temp_min": 57.2
</span><span class='line'>    },
</span><span class='line'>    "name": "San Francisco",
</span><span class='line'>    "weather": [
</span><span class='line'>        {
</span><span class='line'>            "description": "haze",
</span><span class='line'>            "icon": "50d",
</span><span class='line'>            "id": 721,
</span><span class='line'>            "main": "Haze"
</span><span class='line'>        }
</span><span class='line'>    ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>你需要把嵌套的JSON值映射到Objective-C的属性。嵌套的JSON值是元素，如温度，即上面看到的<code>main</code>节点。</p>

<p>要做到这一点，你将利用的Objective-C的<a href="https://developer.apple.com/library/ios/documentation/cocoa/conceptual/KeyValueCoding/Articles/BasicPrinciples.html">Key-Value Coding</a>和Mantle<a href="https://github.com/MantleFramework/Mantle/blob/master/Mantle/MTLJSONAdapter.h">的MTLJSONAdapter</a>。</p>

<p>还在<code>WXCondition.m</code>，通过添加<code>+JSONKeyPathsByPropertyKey</code>方法，“JSON到模型属性”的映射，且该方法是<code>MTLJSONSerializing</code>协议的<a href="https://github.com/MantleFramework/Mantle/blob/master/Mantle/MTLJSONAdapter.h#L17-28">require</a>。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (NSDictionary *)JSONKeyPathsByPropertyKey {
</span><span class='line'>    return @{
</span><span class='line'>             @"date": @"dt",
</span><span class='line'>             @"locationName": @"name",
</span><span class='line'>             @"humidity": @"main.humidity",
</span><span class='line'>             @"temperature": @"main.temp",
</span><span class='line'>             @"tempHigh": @"main.temp_max",
</span><span class='line'>             @"tempLow": @"main.temp_min",
</span><span class='line'>             @"sunrise": @"sys.sunrise",
</span><span class='line'>             @"sunset": @"sys.sunset",
</span><span class='line'>             @"conditionDescription": @"weather.description",
</span><span class='line'>             @"condition": @"weather.main",
</span><span class='line'>             @"icon": @"weather.icon",
</span><span class='line'>             @"windBearing": @"wind.deg",
</span><span class='line'>             @"windSpeed": @"wind.speed"
</span><span class='line'>             };
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>在这个方法里，dictionary的key是<code>WXCondition</code>的属性名称，而dictionary的value是JSON的路径。</p>

<p>您可能已经注意到，这里有一个从JSON数据映射到Objective-C属性的问题。属性<code>date</code>是<code>NSDate</code>类型的，但JSON有一个Unix时间类型(sjpsega注:即从1970年1月1日0时0分0秒起至现在的总秒数)的NSInteger值。你需要完成两者之间的转换。</p>

<p>Mantle正好有一个功能来为你解决这个问题：<a href="https://github.com/github/Mantle/blob/master/Mantle/MTLValueTransformer.h">MTLValueTransformer</a>。这个类允许你声明一个block，详细说明值的相互转换。</p>

<p>Mantle的转换器语法有点怪。要创建一个为一个特定属性的转换器，，您可以添加一个以属性名开头和<code>JSONTransformer</code>结尾的类方法。
可能看实际代码比试图解释它更容易理解，所以在<code>WXCondition.m</code>中添加以下为NSDate属性设置的转换器。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (NSValueTransformer *)dateJSONTransformer {
</span><span class='line'>    // 1
</span><span class='line'>    return [MTLValueTransformer reversibleTransformerWithForwardBlock:^(NSString *str) {
</span><span class='line'>        return [NSDate dateWithTimeIntervalSince1970:str.floatValue];
</span><span class='line'>    } reverseBlock:^(NSDate *date) {
</span><span class='line'>        return [NSString stringWithFormat:@"%f",[date timeIntervalSince1970]];
</span><span class='line'>    }];
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>// 2
</span><span class='line'>+ (NSValueTransformer *)sunriseJSONTransformer {
</span><span class='line'>    return [self dateJSONTransformer];
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>+ (NSValueTransformer *)sunsetJSONTransformer {
</span><span class='line'>    return [self dateJSONTransformer];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ol>
<li>使用blocks做属性的转换的工作，并返回一个MTLValueTransformer返回值。</li>
<li>您只需要详细说明Unix时间和NSDate之间进行转换一次，就可以重用<code>-dateJSONTransformer</code>方法为sunrise和sunset属性做转换。</li>
</ol>


<p>下一个值转型有点讨厌，但它只是使用OpenWeatherMap的API，并自己的格式化JSON响应方式的结果。<code>weather</code>键对应的值是一个JSON数组，但你只关注单一的天气状况。</p>

<p>在<code>WXCondition.m</code>中，使用<code>dateJSONTransformer</code>相同的结构，您可以创建一个NSArray和NSString的之间的转换。该解决方案提供如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (NSValueTransformer *)conditionDescriptionJSONTransformer {
</span><span class='line'>    return [MTLValueTransformer reversibleTransformerWithForwardBlock:^(NSArray *values) {
</span><span class='line'>        return [values firstObject];
</span><span class='line'>    } reverseBlock:^(NSString *str) {
</span><span class='line'>        return @[str];
</span><span class='line'>    }];
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>+ (NSValueTransformer *)conditionJSONTransformer {
</span><span class='line'>    return [self conditionDescriptionJSONTransformer];
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>+ (NSValueTransformer *)iconJSONTransformer {
</span><span class='line'>    return [self conditionDescriptionJSONTransformer];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>最后的转换器只是为了格式化。 OpenWeatherAPI使用每秒/米的风速。由于您的App使用英制系统，你需要将其转换为每小时/英里。</p>

<p>在<code>WXCondition.m</code>的实现中添加以下转换器的方法和宏定义。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define MPS_TO_MPH 2.23694f
</span><span class='line'> 
</span><span class='line'>+ (NSValueTransformer *)windSpeedJSONTransformer {
</span><span class='line'>    return [MTLValueTransformer reversibleTransformerWithForwardBlock:^(NSNumber *num) {
</span><span class='line'>        return @(num.floatValue*MPS_TO_MPH);
</span><span class='line'>    } reverseBlock:^(NSNumber *speed) {
</span><span class='line'>        return @(speed.floatValue/MPS_TO_MPH);
</span><span class='line'>    }];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>在OpenWeatherMap的API中有一个小的差异，你必须处理。看一看在位于<a href="http://api.openweathermap.org/data/2.5/weather?lat=37.785834&amp;lon=-122.406417&amp;units=imperial">当前状况的响应</a>和<a href="http://api.openweathermap.org/data/2.5/forecast/daily?lat=37.785834&amp;lon=-122.406417&amp;units=imperial&amp;cnt=7">每日预测反应</a>之间的温度：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// current
</span><span class='line'>"main": {
</span><span class='line'>    "grnd_level": 1021.87,
</span><span class='line'>    "humidity": 64,
</span><span class='line'>    "pressure": 1021.87,
</span><span class='line'>    "sea_level": 1030.6,
</span><span class='line'>    "temp": 58.09,
</span><span class='line'>    "temp_max": 58.09,
</span><span class='line'>    "temp_min": 58.09
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>// daily forecast
</span><span class='line'>"temp": {
</span><span class='line'>    "day": 58.14,
</span><span class='line'>    "eve": 58.14,
</span><span class='line'>    "max": 58.14,
</span><span class='line'>    "min": 57.18,
</span><span class='line'>    "morn": 58.14,
</span><span class='line'>    "night": 57.18
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>current</code>的第一个key是<code>main</code>，最高温度存储在key <code>temp_max</code>中，而<code>daily forecast</code>的第一个key是<code>temp</code>，最高温度存储在key <code>max</code>中。</p>

<p>key Temperature的差异放在一边，其他都一样。所以，你真正需要做的是修改daily forecasts的键映射。</p>

<p>打开<code>WXDailyForecast.m</code>重写<code>+JSONKeyPathsByPropertyKey</code>方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (NSDictionary *)JSONKeyPathsByPropertyKey {
</span><span class='line'>    // 1
</span><span class='line'>    NSMutableDictionary *paths = [[super JSONKeyPathsByPropertyKey] mutableCopy];
</span><span class='line'>    // 2
</span><span class='line'>    paths[@"tempHigh"] = @"temp.max";
</span><span class='line'>    paths[@"tempLow"] = @"temp.min";
</span><span class='line'>    // 3
</span><span class='line'>    return paths;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ol>
<li>获取<code>WXCondition</code>的映射，并创建它的可变副本。</li>
<li>你需要为daily forecast做的是改变max和min键映射。</li>
<li>返回新的映射。</li>
</ol>


<p>构建并运行您的App，看起来和上次运行没什么改变，但好的一点是，App编译和运行没有任何错误。</p>

<p><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2013/11/built-layout.jpg" width="320" alt="Labels and Views" /></p>

<h2>何去何从？</h2>

<p>你可以从<a href="http://cdn4.raywenderlich.com/wp-content/uploads/2013/11/SimpleWeather-Part-1.zip">这里</a>下载完整程序。</p>

<p>在这部分教程中，您使用Cocoapods设置项目，增加视图到控制器，编排视图，并建立模型来反映你抓取的气象数据。该App还没有充分发挥作用，但是你成功用纯代码创建视图，并学习了如何使用Mantle映射和转换JSON数据。</p>

<p>接下来看看<a href="/blog/2014/02/15/yi--ios-7-best-practices-part-2/">教程的第二部分</a>，你将充实你的App，从weather API获取数据，并在UI上显示。您将使用新的iOS7 <a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSURLSession_class/Introduction/Introduction.html">NSURLSession</a>去下载数据，以及使用<code>ReactiveCocoa</code>把位置查找，天气数据抓取和UI更新事件绑在一起。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">sjpsega</span></span>

      




<time class='entry-date' datetime='2014-02-11T22:21:53+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:21 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/study/'>study</a>
  
</span>


    </p>
    <p class="meta">
      版权声明：自由转载-非商用-非衍生-保持署名 | <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">CC BY-NC-ND 3.0</a>
    </p>
    
      <div class="sharing">
  
  
  
  
      <!--jiathis与友言-->
<!-- JiaThis Button BEGIN -->
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1891960" charset="utf-8"></script>
<!-- JiaThis Button END -->
<!-- UY BEGIN -->
<script type="text/javascript">
var uyan_config = {
   'du':'sjpsega.com'
};
</script>
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1891960"></script>
<!-- UY END -->
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/02/06/kai-shi-xie-blog/" title="Previous Post: 开始写Blog">&laquo; 开始写Blog</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/02/15/yi--ios-7-best-practices-part-2/" title="Next Post: [译]iOS7最佳实践：一个天气App案例(二)">[译]iOS7最佳实践：一个天气App案例(二) &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/07/04/2020midyear-invest-summary/">2020 年中投资总结</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/02/15/2019summary/">2019 年终总结</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/02/09/soho/">SOHO 工作一周的感受</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/10/putitdown/">放下</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/01/2020-invest-summary/">2019 年投资总结</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>About Me</h1>
  <p>程序员</p>
  <p>技术经历：As -> Js -> iOS</p>
  <p>新浪微博：<a href="http://weibo.com/sjpsega">IORI_YAGAMI_7</a></p>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - sjpsega -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  









<!--cnzz统计-->
<script src="http://s13.cnzz.com/stat.php?id=5808684&web_id=5808684" language="JavaScript"></script>

</body>
</html>
