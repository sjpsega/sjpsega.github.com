
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>sjpsega's Blog</title>
  <meta name="author" content="sjpsega">

  
  <meta name="description" content="注：本文译自：raywenderlich ios-7-best-practices-part-2，去除了跟主题无关的寒暄部分。
欢迎转载，保持署名 开始 你有两个选择开始本教程：您可以使用在本教程的第1部分你已完成的项目，或者你可以在这里下载第1部分已完成的项目。 &hellip;">
  

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--友言验证-->
  <meta name="uyan_auth" content="7d2af41cee" />
  
  <link rel="canonical" href="http://sjpsega.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="sjpsega's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/jquery.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts 
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
-->
  

</head>
<script type="text/javascript">
//链接新开窗口
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">sjpsega's Blog</a></h1>
  
    <h2>记录我的生活与学习.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sjpsega.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
  <li><a href="/blog/categories/study">学习</a></li>
  <li><a href="/blog/categories/life">生活</a></li>
  <li><a href="http://weibo.com/sjpsega" target="_blank">我的微博</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/15/yi--ios-7-best-practices-part-2/">[译]iOS7最佳实践：一个天气App案例(二)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-15T16:46:02+08:00" pubdate data-updated="true">Feb 15<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>注：本文译自：<a href="http://www.raywenderlich.com/55385/ios-7-best-practices-part-2">raywenderlich ios-7-best-practices-part-2</a>，去除了跟主题无关的寒暄部分。
欢迎转载，保持署名</p>

<h2>开始</h2>

<p>你有两个选择开始本教程：您可以使用在本教程的第1部分你已完成的项目，或者你可以在这里下载<a href="http://cdn4.raywenderlich.com/wp-content/uploads/2013/11/SimpleWeather-Part-1.zip">第1部分已完成的项目</a>。</p>

<p>在前面的教程中你创建了你的App的天气模型 &ndash; 现在你需要使用OpenWeatherMap API为你的App来获取一些数据。你将使用两个类抽象数据抓取、分析、存储：<code>WXClient</code>和<code>WXManager</code>。</p>

<p><code>WXClient</code>的唯一责任是创建API请求，并解析它们；别人可以不用担心用数据做什么以及如何存储它。划分类的不同工作职责的设计模式被称为关注点分离。这使你的代码更容易理解，扩展和维护。</p>

<h2>与ReactiveCocoa工作</h2>

<p>确保你使用<code>SimpleWeather.xcworkspace</code>,打开<code>WXClient.h</code>并增加imports</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">@</span><span class="n">import</span> <span class="n">CoreLocation</span><span class="p">;</span>
</span><span class='line'><span class="cp">#import &lt;ReactiveCocoa/ReactiveCocoa/ReactiveCocoa.h&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">注意：您可能之前没有见过的@</span><span class="n">import</span><span class="err">指令，它在</span><span class="n">Xcode5</span><span class="err">中被引入，是由苹果公司看作是一个现代的，更高效的替代</span> <span class="err">#</span><span class="n">import</span><span class="err">。有一个非常好的教程，涵盖了最新的</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span><span class="err">特性</span><span class="o">-</span><span class="p">[</span><span class="n">What</span><span class="err">’</span><span class="n">s</span> <span class="n">New</span> <span class="k">in</span> <span class="n">Objective</span><span class="o">-</span><span class="n">C</span> <span class="n">and</span> <span class="n">Foundation</span> <span class="k">in</span> <span class="n">iOS</span> <span class="mi">7</span><span class="p">](</span><span class="nl">http:</span><span class="c1">//www.raywenderlich.com/49850/whats-new-in-objective-c-and-foundation-in-ios-7)。</span>
</span></code></pre></td></tr></table></div></figure>


<p>在<code>WXClient.h</code>中添加下列四个方法到接口申明：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">@</span><span class="n">import</span> <span class="n">Foundation</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">fetchJSONFromURL:</span><span class="p">(</span><span class="n">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="nv">url</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">fetchCurrentConditionsForLocation:</span><span class="p">(</span><span class="n">CLLocationCoordinate2D</span><span class="p">)</span><span class="nv">coordinate</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">fetchHourlyForecastForLocation:</span><span class="p">(</span><span class="n">CLLocationCoordinate2D</span><span class="p">)</span><span class="nv">coordinate</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">fetchDailyForecastForLocation:</span><span class="p">(</span><span class="n">CLLocationCoordinate2D</span><span class="p">)</span><span class="nv">coordinate</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在，似乎是一个很好的机会来介绍<a href="https://github.com/ReactiveCocoa/ReactiveCocoa">ReactiveCocoa</a>！</p>

<p>ReactiveCocoa（RAC）是一个Objective-C的框架，用于函数式反应型编程，它提供了组合和转化数据流的API。代替专注于编写串行的代码 &ndash; 执行有序的代码队列 &ndash; 可以响应非确定性事件。</p>

<p>Github上提供的<a href="https://github.com/blog/1107-reactivecocoa-for-a-better-world">a great overview of the benefits</a>：</p>

<ul>
<li>对未来数据的进行组合操作的能力。</li>
<li>减少状态和可变性。</li>
<li>用声明的形式来定义行为和属性之间的关系。</li>
<li>为异步操作带来一个统一的，高层次的接口。</li>
<li>在KVO的基础上建立一个优雅的API。</li>
</ul>


<p>例如，你可以监听<code>username</code>属性的变化，用这样的代码:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="n">RACAble</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">username</span><span class="p">)</span> <span class="nl">subscribeNext:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">newName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">newName</span><span class="p">);</span>
</span><span class='line'><span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>subscribeNext</code>这个block会在<code>self.username</code>属性变化的时候执行。新的值会传递给这个block。</p>

<p>您还可以合并信号并组合数据到一个组合数据中。下面的示例取自于ReactiveCocoa的Github页面：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[[</span><span class="n">RACSignal</span>
</span><span class='line'>    <span class="nl">combineLatest:</span><span class="err">@</span><span class="p">[</span> <span class="n">RACAble</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">password</span><span class="p">),</span> <span class="n">RACAble</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">passwordConfirmation</span><span class="p">)</span> <span class="p">]</span>
</span><span class='line'>           <span class="nl">reduce:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">currentPassword</span><span class="p">,</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">currentConfirmPassword</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>               <span class="k">return</span> <span class="p">[</span><span class="n">NSNumber</span> <span class="nl">numberWithBool:</span><span class="p">[</span><span class="n">currentConfirmPassword</span> <span class="nl">isEqualToString:</span><span class="n">currentPassword</span><span class="p">]];</span>
</span><span class='line'>           <span class="p">}]</span>
</span><span class='line'>    <span class="nl">subscribeNext:</span><span class="o">^</span><span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="n">passwordsMatch</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">createEnabled</span> <span class="o">=</span> <span class="p">[</span><span class="n">passwordsMatch</span> <span class="n">boolValue</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/ReactiveCocoaFramework/ReactiveCocoa/RACSignal.h">RACSignal</a>对象捕捉当前和未来的值。信号可以被观察者链接，组合和反应。信号实际上不会执行，直到它被订阅。</p>

<p>这意味着调用<code>[mySignal fetchCurrentConditionsForLocation：someLocation];</code>不会做什么，但创建并返回一个信号。你将看到之后如何订阅和反应。</p>

<p>打开<code>WXClient.m</code>加入以下imports:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#import &quot;WXCondition.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;WXDailyForecast.h&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>在imports下，添加私有接口：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">WXClient</span> <span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSURLSession</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个接口用这个属性来管理API请求的URL session。</p>

<p>添加以下<code>init</code>放到到<code>@implementation</code>和<code>@end</code>之间：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSURLSessionConfiguration</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLSessionConfiguration</span> <span class="n">defaultSessionConfiguration</span><span class="p">];</span>
</span><span class='line'>        <span class="n">_session</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLSession</span> <span class="nl">sessionWithConfiguration:</span><span class="n">config</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用<code>defaultSessionConfiguration</code>为您创建session。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">注意：如果你以前没有了解过</span><span class="n">NSURLSession</span><span class="err">，看看我们的</span><span class="p">[</span><span class="n">NSURLSession</span><span class="err">教程</span><span class="p">](</span><span class="nl">http:</span><span class="c1">//www.raywenderlich.com/51127/nsurlsession-tutorial)，了解更多信息。</span>
</span></code></pre></td></tr></table></div></figure>


<h2>构建信号</h2>

<p>你需要一个主方法来建立一个信号从URL中取数据。你已经知道，需要三种方法来获取当前状况，逐时预报及每日预报。</p>

<p>不是写三个独立的方法，你可以遵守<a href="http://en.wikipedia.org/wiki/Don't_repeat_yourself">DRY</a>（Don’t Repeat Yourself）的软件设计理念，使您的代码容易维护。</p>

<p>第一次看，以下的一些ReactiveCocoa部分可能看起来相当陌生。别担心，你会一块一块理解他。</p>

<p>增加下列方法到<code>WXClient.m</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">fetchJSONFromURL:</span><span class="p">(</span><span class="n">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="nv">url</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Fetching: %@&quot;</span><span class="p">,</span><span class="n">url</span><span class="p">.</span><span class="n">absoluteString</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">RACSignal</span> <span class="nl">createSignal:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 2</span>
</span><span class='line'>        <span class="n">NSURLSessionDataTask</span> <span class="o">*</span><span class="n">dataTask</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">session</span> <span class="nl">dataTaskWithURL:</span><span class="n">url</span> <span class="nl">completionHandler:</span><span class="o">^</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">NSURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// TODO: Handle retrieved data</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 3</span>
</span><span class='line'>        <span class="p">[</span><span class="n">dataTask</span> <span class="n">resume</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 4</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">RACDisposable</span> <span class="nl">disposableWithBlock:</span><span class="o">^</span><span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="n">dataTask</span> <span class="n">cancel</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>    <span class="p">}]</span> <span class="nl">doError:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 5</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过一个一个注释，你会看到代码执行以下操作：</p>

<ol>
<li>返回信号。请记住，这将不会执行，直到这个信号被订阅。 <code>- fetchJSONFromURL：</code>创建一个对象给其他方法和对象使用；这种行为有时也被称为<a href="https://developer.apple.com/library/ios/documentation/general/conceptual/CocoaEncyclopedia/ClassFactoryMethods/ClassFactoryMethods.html">工厂模式</a>。</li>
<li>创建一个<a href="https://developer.apple.com/library/IOS/documentation/Foundation/Reference/NSURLSessionDataTask_class/Reference/Reference.html">NSURLSessionDataTask</a>（在iOS7中加入）从URL取数据。你会在以后添加的数据解析。</li>
<li>一旦订阅了信号，启动网络请求。</li>
<li>创建并返回<a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/ReactiveCocoaFramework/ReactiveCocoa/RACDisposable.h">RACDisposable</a>对象，它处理当信号摧毁时的清理工作。</li>
<li>增加了一个“side effect”，以记录发生的任何错误。side effect不订阅信号，相反，他们返回被连接到方法链的信号。你只需添加一个side effect来记录错误。</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">如果你觉得需要更多一些背景知识，看看由</span><span class="n">Ash</span> <span class="n">Furrow</span><span class="err">编写的</span><span class="p">[</span><span class="err">这篇文章</span><span class="p">](</span><span class="nl">http:</span><span class="c1">//www.teehanlax.com/blog/getting-started-with-reactivecocoa/)，以便更好地了解ReactiveCocoa的核心概念。</span>
</span></code></pre></td></tr></table></div></figure>


<p>在<code>-fetchJSONFromURL:</code>中找到<code>// TODO: Handle retrieved data</code> ，替换为:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSError</span> <span class="o">*</span><span class="n">jsonError</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">id</span> <span class="n">json</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">JSONObjectWithData:</span><span class="n">data</span> <span class="nl">options:</span><span class="n">kNilOptions</span> <span class="nl">error:</span><span class="o">&amp;</span><span class="n">jsonError</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">jsonError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 1</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext:</span><span class="n">json</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 2</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendError:</span><span class="n">jsonError</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 2</span>
</span><span class='line'>    <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendError:</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'><span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>当JSON数据存在并且没有错误，发送给订阅者序列化后的JSON数组或字典。</li>
<li>在任一情况下如果有一个错误，通知订阅者。</li>
<li>无论该请求成功还是失败，通知订阅者请求已经完成。</li>
</ol>


<p><code>-fetchJSONFromURL：</code>方法有点长，但它使你的特定的API请求方法变得很简单。</p>

<h2>获取当前状况</h2>

<p>还在<code>WXClient.m</code>中，添加如下方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">fetchCurrentConditionsForLocation:</span><span class="p">(</span><span class="n">CLLocationCoordinate2D</span><span class="p">)</span><span class="nv">coordinate</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">urlString</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;http://api.openweathermap.org/data/2.5/weather?lat=%f&amp;lon=%f&amp;units=imperial&quot;</span><span class="p">,</span><span class="n">coordinate</span><span class="p">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">.</span><span class="n">longitude</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">urlString</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 2</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">self</span> <span class="nl">fetchJSONFromURL:</span><span class="n">url</span><span class="p">]</span> <span class="nl">map:</span><span class="o">^</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">json</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 3</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">MTLJSONAdapter</span> <span class="nl">modelOfClass:</span><span class="p">[</span><span class="n">WXCondition</span> <span class="n">class</span><span class="p">]</span> <span class="nl">fromJSONDictionary:</span><span class="n">json</span> <span class="nl">error:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>使用<code>CLLocationCoordinate2D</code>对象的经纬度数据来格式化URL。</li>
<li>用你刚刚建立的创建信号的方法。由于返回值是一个信号，你可以调用其他ReactiveCocoa的方法。 在这里，您将返回值映射到一个不同的值 &ndash; 一个NSDictionary实例。</li>
<li>使用<code>MTLJSONAdapter</code>来转换JSON到<code>WXCondition</code>对象 &ndash; 使用<code>MTLJSONSerializing</code>协议创建的<code>WXCondition</code>。</li>
</ol>


<h2>获取逐时预报</h2>

<p>现在添加根据坐标获取逐时预报的方法到<code>WXClient.m</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">fetchHourlyForecastForLocation:</span><span class="p">(</span><span class="n">CLLocationCoordinate2D</span><span class="p">)</span><span class="nv">coordinate</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">urlString</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;http://api.openweathermap.org/data/2.5/forecast?lat=%f&amp;lon=%f&amp;units=imperial&amp;cnt=12&quot;</span><span class="p">,</span><span class="n">coordinate</span><span class="p">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">.</span><span class="n">longitude</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">urlString</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">self</span> <span class="nl">fetchJSONFromURL:</span><span class="n">url</span><span class="p">]</span> <span class="nl">map:</span><span class="o">^</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">json</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 2</span>
</span><span class='line'>        <span class="n">RACSequence</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="p">[</span><span class="s">@&quot;list&quot;</span><span class="p">]</span> <span class="n">rac_sequence</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 3</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[[</span><span class="n">list</span> <span class="nl">map:</span><span class="o">^</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 4</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">[</span><span class="n">MTLJSONAdapter</span> <span class="nl">modelOfClass:</span><span class="p">[</span><span class="n">WXCondition</span> <span class="n">class</span><span class="p">]</span> <span class="nl">fromJSONDictionary:</span><span class="n">item</span> <span class="nl">error:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>        <span class="c1">// 5</span>
</span><span class='line'>        <span class="p">}]</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>再次使用<code>-fetchJSONFromUR</code>方法，映射JSON。注意：重复使用该方法节省了多少代码！</li>
<li>使用JSON的&#8221;list&#8221;key创建<code>RACSequence</code>。 <code>RACSequences</code>让你对列表进行ReactiveCocoa操作。</li>
<li>映射新的对象列表。调用<code>-map：</code>方法，针对列表中的每个对象，返回新对象的列表。</li>
<li>再次使用<code>MTLJSONAdapter</code>来转换JSON到<code>WXCondition</code>对象。</li>
<li>使用<code>RACSequence</code>的<code>-map</code>方法，返回另一个<code>RACSequence</code>，所以用这个简便的方法来获得一个<code>NSArray</code>数据。</li>
</ol>


<h2>获取每日预报</h2>

<p>最后，添加如下方法到<code>WXClient.m</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">fetchDailyForecastForLocation:</span><span class="p">(</span><span class="n">CLLocationCoordinate2D</span><span class="p">)</span><span class="nv">coordinate</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">urlString</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;http://api.openweathermap.org/data/2.5/forecast/daily?lat=%f&amp;lon=%f&amp;units=imperial&amp;cnt=7&quot;</span><span class="p">,</span><span class="n">coordinate</span><span class="p">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">.</span><span class="n">longitude</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="n">urlString</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Use the generic fetch method and map results to convert into an array of Mantle objects</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">self</span> <span class="nl">fetchJSONFromURL:</span><span class="n">url</span><span class="p">]</span> <span class="nl">map:</span><span class="o">^</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">json</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Build a sequence from the list of raw JSON</span>
</span><span class='line'>        <span class="n">RACSequence</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="p">[</span><span class="s">@&quot;list&quot;</span><span class="p">]</span> <span class="n">rac_sequence</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Use a function to map results from JSON to Mantle objects</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[[</span><span class="n">list</span> <span class="nl">map:</span><span class="o">^</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">[</span><span class="n">MTLJSONAdapter</span> <span class="nl">modelOfClass:</span><span class="p">[</span><span class="n">WXDailyForecast</span> <span class="n">class</span><span class="p">]</span> <span class="nl">fromJSONDictionary:</span><span class="n">item</span> <span class="nl">error:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}]</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>是不是看起来很熟悉？是的，这个方法与<code>-fetchHourlyForecastForLocation:</code>方法非常像。除了它使用<code>WXDailyForecast</code>代替<code>WXCondition</code>，并获取每日预报。</p>

<p>构建并运行您的App，现在你不会看到任何新的东西，但这是一个很好机会松一口气，并确保没有任何错误或警告。</p>

<p><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2013/11/built-layout.jpg" width="320" alt="Labels and Views" /></p>

<h2>管理并存储你的数据</h2>

<p>现在是时间来充实<code>WXManager</code>，这个类会把所有东西结合到一起。这个类实现您App的一些关键功能：</p>

<ul>
<li>它使用<a href="http://www.raywenderlich.com/46988/ios-design-patterns">单例设计模式</a>。</li>
<li>它试图找到设备的位置。</li>
<li>找到位置后，它获取相应的气象数据。</li>
</ul>


<p>打开<code>WXManager.h</code>使用以下代码来替换其内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">@</span><span class="n">import</span> <span class="n">Foundation</span><span class="p">;</span>
</span><span class='line'><span class="err">@</span><span class="n">import</span> <span class="n">CoreLocation</span><span class="p">;</span>
</span><span class='line'><span class="cp">#import &lt;ReactiveCocoa/ReactiveCocoa/ReactiveCocoa.h&gt;</span>
</span><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="cp">#import &quot;WXCondition.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">WXManager</span> : <span class="nc">NSObject</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">CLLocationManagerDelegate</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="o">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">sharedManager</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">CLLocation</span> <span class="o">*</span><span class="n">currentLocation</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">WXCondition</span> <span class="o">*</span><span class="n">currentCondition</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">hourlyForecast</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">dailyForecast</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 4</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">findCurrentLocation</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>请注意，你没有引入<code>WXDailyForecast.h</code>，你会始终使用<code>WXCondition</code>作为预报的类。 <code>WXDailyForecast</code>的存在是为了帮助Mantle转换JSON到Objective-C。</li>
<li>使用<code>instancetype</code>而不是<code>WXManager</code>，子类将返回适当的类型。</li>
<li>这些属性将存储您的数据。由于<code>WXManager</code>是一个单例，这些属性可以任意访问。设置公共属性为只读，因为只有管理者能更改这些值。</li>
<li>这个方法启动或刷新整个位置和天气的查找过程。</li>
</ol>


<p>现在打开<code>WXManager.m</code>并添加如下imports到文件顶部：</p>

<pre><code>#import "WXClient.h"
#import &lt;TSMessages/TSMessage.h&gt;
</code></pre>

<p>在imports下方，粘贴如下私有接口：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">WXManager</span> <span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="n">WXCondition</span> <span class="o">*</span><span class="n">currentCondition</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="n">CLLocation</span> <span class="o">*</span><span class="n">currentLocation</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">hourlyForecast</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">dailyForecast</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">CLLocationManager</span> <span class="o">*</span><span class="n">locationManager</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">isFirstUpdate</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">WXClient</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>声明你在公共接口中添加的相同的属性，但是这一次把他们定义为<code>可读写</code>，因此您可以在后台更改他们。</li>
<li>为查找定位和数据抓取声明一些私有变量。</li>
</ol>


<p>添加如下通用的单例构造器到<code>@implementation</code>与<code>@end</code>å中间：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="nf">sharedManager</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">id</span> <span class="n">_sharedManager</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">onceToken</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">_sharedManager</span> <span class="o">=</span> <span class="p">[[</span><span class="n">self</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">_sharedManager</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后，你需要设置你的属性和观察者。</p>

<p>添加如下方法到<code>WXManager.m</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 1</span>
</span><span class='line'>        <span class="n">_locationManager</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CLLocationManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="n">_locationManager</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 2</span>
</span><span class='line'>        <span class="n">_client</span> <span class="o">=</span> <span class="p">[[</span><span class="n">WXClient</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 3</span>
</span><span class='line'>        <span class="p">[[[[</span><span class="n">RACObserve</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">currentLocation</span><span class="p">)</span>
</span><span class='line'>            <span class="c1">// 4</span>
</span><span class='line'>            <span class="nl">ignore:</span><span class="nb">nil</span><span class="p">]</span>
</span><span class='line'>            <span class="c1">// 5</span>
</span><span class='line'>           <span class="c1">// Flatten and subscribe to all 3 signals when currentLocation updates</span>
</span><span class='line'>           <span class="nl">flattenMap:</span><span class="o">^</span><span class="p">(</span><span class="n">CLLocation</span> <span class="o">*</span><span class="n">newLocation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>               <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">merge:</span><span class="err">@</span><span class="p">[</span>
</span><span class='line'>                                         <span class="p">[</span><span class="n">self</span> <span class="n">updateCurrentConditions</span><span class="p">],</span>
</span><span class='line'>                                         <span class="p">[</span><span class="n">self</span> <span class="n">updateDailyForecast</span><span class="p">],</span>
</span><span class='line'>                                         <span class="p">[</span><span class="n">self</span> <span class="n">updateHourlyForecast</span><span class="p">]</span>
</span><span class='line'>                                         <span class="p">]];</span>
</span><span class='line'>            <span class="c1">// 6</span>
</span><span class='line'>           <span class="p">}]</span> <span class="nl">deliverOn:</span><span class="n">RACScheduler</span><span class="p">.</span><span class="n">mainThreadScheduler</span><span class="p">]</span>
</span><span class='line'>           <span class="c1">// 7</span>
</span><span class='line'>         <span class="nl">subscribeError:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>             <span class="p">[</span><span class="n">TSMessage</span> <span class="nl">showNotificationWithTitle:</span><span class="s">@&quot;Error&quot;</span>
</span><span class='line'>                                         <span class="nl">subtitle:</span><span class="s">@&quot;There was a problem fetching the latest weather.&quot;</span>
</span><span class='line'>                                             <span class="nl">type:</span><span class="n">TSMessageNotificationTypeError</span><span class="p">];</span>
</span><span class='line'>         <span class="p">}];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>你正使用更多的ReactiveCocoa方法来观察和反应数值的变化。上面这些你做了：</p>

<ol>
<li>创建一个位置管理器，并设置它的delegate为<code>self</code>。</li>
<li>为管理器创建<code>WXClient</code>对象。这里处理所有的网络请求和数据分析，这是关注点分离的最佳实践。</li>
<li>管理器使用一个返回信号的ReactiveCocoa脚本来观察自身的<code>currentLocation</code>。这与<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">KVO</a>类似，但更为强大。</li>
<li>为了继续执行方法链，<code>currentLocation</code>必须不为<code>nil</code>。</li>
<li><code>- flattenMap：</code>非常类似于<code>-map：</code>，但不是映射每一个值，它把数据变得扁平，并返回包含三个信号中的一个对象。通过这种方式，你可以考虑将三个进程作为单个工作单元。</li>
<li>将信号传递给主线程上的观察者。</li>
<li>这不是很好的做法，在你的模型中进行UI交互，但出于演示的目的，每当发生错误时，会显示一个banner。</li>
</ol>


<p>接下来，为了显示准确的天气预报，我们需要确定设备的位置。</p>

<h2>查找你的位置</h2>

<p>下一步，你要添加当位置查找到，触发抓取天气数据的代码。</p>

<p>添加如下代码到<code>WXManager.m</code>的实现块中:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">findCurrentLocation</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">isFirstUpdate</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">startUpdatingLocation</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">didUpdateLocations:</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">locations</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">isFirstUpdate</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">isFirstUpdate</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CLLocation</span> <span class="o">*</span><span class="n">location</span> <span class="o">=</span> <span class="p">[</span><span class="n">locations</span> <span class="n">lastObject</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 2</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">location</span><span class="p">.</span><span class="n">horizontalAccuracy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 3</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">currentLocation</span> <span class="o">=</span> <span class="n">location</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">locationManager</span> <span class="n">stopUpdatingLocation</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>忽略第一个位置更新，因为它一般是缓存值。</li>
<li>一旦你获得一定精度的位置，停止进一步的更新。</li>
<li>设置<code>currentLocation</code>，将触发您之前在init中设置的RACObservable。</li>
</ol>


<h2>获取气象数据</h2>

<p>最后，是时候添加在客户端上调用并保存数据的三个获取方法。将三个方法捆绑起来，被之前在<code>init</code>方法中添加的RACObservable订阅。您将返回客户端返回的，能被订阅的，相同的信号。</p>

<p>所有的属性设置发生在<code>-doNext:</code>中。</p>

<p>添加如下代码到<code>WXManager.m</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">updateCurrentConditions</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="nl">fetchCurrentConditionsForLocation:</span><span class="n">self</span><span class="p">.</span><span class="n">currentLocation</span><span class="p">.</span><span class="n">coordinate</span><span class="p">]</span> <span class="nl">doNext:</span><span class="o">^</span><span class="p">(</span><span class="n">WXCondition</span> <span class="o">*</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">currentCondition</span> <span class="o">=</span> <span class="n">condition</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">updateHourlyForecast</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="nl">fetchHourlyForecastForLocation:</span><span class="n">self</span><span class="p">.</span><span class="n">currentLocation</span><span class="p">.</span><span class="n">coordinate</span><span class="p">]</span> <span class="nl">doNext:</span><span class="o">^</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">conditions</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">hourlyForecast</span> <span class="o">=</span> <span class="n">conditions</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">updateDailyForecast</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="nl">fetchDailyForecastForLocation:</span><span class="n">self</span><span class="p">.</span><span class="n">currentLocation</span><span class="p">.</span><span class="n">coordinate</span><span class="p">]</span> <span class="nl">doNext:</span><span class="o">^</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">conditions</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">dailyForecast</span> <span class="o">=</span> <span class="n">conditions</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>它看起来像将一切都连接起来，并蓄势待发。别急！这App实际上并没有告诉管理者做任何事情。
打开<code>WXController.m</code>并导入这管理者到文件的顶部，如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#import &quot;WXManager.h&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>添加如下代码到<code>-viewDidLoad:</code>的最后:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[[</span><span class="n">WXManager</span> <span class="n">sharedManager</span><span class="p">]</span> <span class="n">findCurrentLocation</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>这告诉管理类，开始寻找设备的当前位置。</p>

<p>构建并运行您的App，系统会提示您是否允许使用位置服务。你仍然不会看到任何UI的更新，但检查控制台日志，你会看到类似以下内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">05</span> <span class="mi">08</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mf">48.886</span> <span class="n">WeatherTutorial</span><span class="p">[</span><span class="mi">17097</span><span class="o">:</span><span class="mi">70</span><span class="n">b</span><span class="p">]</span> <span class="nl">Fetching:</span> <span class="nl">http:</span><span class="c1">//api.openweathermap.org/data/2.5/weather?lat=37.785834&amp;lon=-122.406417&amp;units=imperial</span>
</span><span class='line'><span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">05</span> <span class="mi">08</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mf">48.886</span> <span class="n">WeatherTutorial</span><span class="p">[</span><span class="mi">17097</span><span class="o">:</span><span class="mi">70</span><span class="n">b</span><span class="p">]</span> <span class="nl">Fetching:</span> <span class="nl">http:</span><span class="c1">//api.openweathermap.org/data/2.5/forecast/daily?lat=37.785834&amp;lon=-122.406417&amp;units=imperial&amp;cnt=7</span>
</span><span class='line'><span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">05</span> <span class="mi">08</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mf">48.886</span> <span class="n">WeatherTutorial</span><span class="p">[</span><span class="mi">17097</span><span class="o">:</span><span class="mi">70</span><span class="n">b</span><span class="p">]</span> <span class="nl">Fetching:</span> <span class="nl">http:</span><span class="c1">//api.openweathermap.org/data/2.5/forecast?lat=37.785834&amp;lon=-122.406417&amp;units=imperial&amp;cnt=12</span>
</span></code></pre></td></tr></table></div></figure>


<p>这些输出代表你的代码工作正常，网络请求正常执行。</p>

<h2>连接接口</h2>

<p>这是最后一次展示所有获取，映射和存储的数据。您将使用ReactiveCocoa来观察<code>WXManager</code>单例的变化和当新数据到达时更新界面。</p>

<p>还在<code>WXController.m</code>，到<code>- viewDidLoad</code>的底部，并添加下面的代码到<code>[[WXManager sharedManager] findCurrentLocation];</code>之前：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="p">[[</span><span class="n">RACObserve</span><span class="p">([</span><span class="n">WXManager</span> <span class="n">sharedManager</span><span class="p">],</span> <span class="n">currentCondition</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">// 2</span>
</span><span class='line'>  <span class="nl">deliverOn:</span><span class="n">RACScheduler</span><span class="p">.</span><span class="n">mainThreadScheduler</span><span class="p">]</span>
</span><span class='line'> <span class="nl">subscribeNext:</span><span class="o">^</span><span class="p">(</span><span class="n">WXCondition</span> <span class="o">*</span><span class="n">newCondition</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>     <span class="c1">// 3</span>
</span><span class='line'>     <span class="n">temperatureLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;%.0f°&quot;</span><span class="p">,</span><span class="n">newCondition</span><span class="p">.</span><span class="n">temperature</span><span class="p">.</span><span class="n">floatValue</span><span class="p">];</span>
</span><span class='line'>     <span class="n">conditionsLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">newCondition</span><span class="p">.</span><span class="n">condition</span> <span class="n">capitalizedString</span><span class="p">];</span>
</span><span class='line'>     <span class="n">cityLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">newCondition</span><span class="p">.</span><span class="n">locationName</span> <span class="n">capitalizedString</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>     <span class="c1">// 4</span>
</span><span class='line'>     <span class="n">iconView</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nl">imageNamed:</span><span class="p">[</span><span class="n">newCondition</span> <span class="n">imageName</span><span class="p">]];</span>
</span><span class='line'> <span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>观察<code>WXManager</code>单例的currentCondition。</li>
<li>传递在主线程上的任何变化，因为你正在更新UI。</li>
<li>使用气象数据更新文本标签；你为文本标签使用<code>newCondition</code>的数据，而不是单例。订阅者的参数保证是最新值。</li>
<li>使用映射的图像文件名来创建一个图像，并将其设置为视图的图标。</li>
</ol>


<p>构建并运行您的App，你会看到当前温度，当前状况和表示当前状况的图标。所有的数据都是实时的。但是，如果你的位置是旧金山，它似乎总是约65度。Lucky San Franciscans! :]</p>

<p><img src="http://cdn3.raywenderlich.com/wp-content/uploads/2013/11/ui-wiring.jpg" width="320" alt="Wiring up the UI" /></p>

<h2>ReactiveCocoa的绑定</h2>

<p>ReactiveCocoa为iOS带来了自己的<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/CocoaBindings/CocoaBindings.html">Cocoa绑定</a>的形式。</p>

<p>不知道是什么绑定？简而言之，他们是一种提供了保持模型和视图的数据同步而无需编写大量&#8221;胶水代码&#8221;的手段，它们允许你建立一个视图和数据块之间的连接， “结合”它们，使得一方的变化反映到另一个中的技术。</p>

<p>这是一个非常强大的概念，不是吗？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">注意：要获得更多的绑定实例代码，请查看</span><span class="p">[</span><span class="n">ReactiveCocoa</span> <span class="n">Readme</span><span class="p">](</span><span class="nl">https:</span><span class="c1">//github.com/ReactiveCocoa/ReactiveCocoa)。</span>
</span></code></pre></td></tr></table></div></figure>


<p>添加如下代码到你上一步添加的代码后面：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="n">RAC</span><span class="p">(</span><span class="n">hiloLabel</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="o">=</span> <span class="p">[[</span><span class="n">RACSignal</span> <span class="nl">combineLatest:</span><span class="err">@</span><span class="p">[</span>
</span><span class='line'>                        <span class="c1">// 2</span>
</span><span class='line'>                        <span class="n">RACObserve</span><span class="p">([</span><span class="n">WXManager</span> <span class="n">sharedManager</span><span class="p">],</span> <span class="n">currentCondition</span><span class="p">.</span><span class="n">tempHigh</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">RACObserve</span><span class="p">([</span><span class="n">WXManager</span> <span class="n">sharedManager</span><span class="p">],</span> <span class="n">currentCondition</span><span class="p">.</span><span class="n">tempLow</span><span class="p">)]</span>
</span><span class='line'>                        <span class="c1">// 3</span>
</span><span class='line'>                        <span class="nl">reduce:</span><span class="o">^</span><span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="n">hi</span><span class="p">,</span> <span class="n">NSNumber</span> <span class="o">*</span><span class="n">low</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">return</span> <span class="p">[</span><span class="n">NSString</span>  <span class="nl">stringWithFormat:</span><span class="s">@&quot;%.0f° / %.0f°&quot;</span><span class="p">,</span><span class="n">hi</span><span class="p">.</span><span class="n">floatValue</span><span class="p">,</span><span class="n">low</span><span class="p">.</span><span class="n">floatValue</span><span class="p">];</span>
</span><span class='line'>                        <span class="p">}]</span>
</span><span class='line'>                        <span class="c1">// 4</span>
</span><span class='line'>                        <span class="nl">deliverOn:</span><span class="n">RACScheduler</span><span class="p">.</span><span class="n">mainThreadScheduler</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的代码结合高温、低温的值到hiloLabel的text属性。看看你完成了什么：</p>

<ol>
<li>RAC（&hellip;）宏有助于保持语法整洁。从该信号的返回值将被分配给<code>hiloLabel</code>对象的<code>text</code>。</li>
<li>观察<code>currentCondition</code>的高温和低温。合并信号，并使用两者最新的值。当任一数据变化时，信号就会触发。</li>
<li>从合并的信号中，减少数值，转换成一个单一的数据，注意参数的顺序与信号的顺序相匹配。</li>
<li>同样，因为你正在处理UI界面，所以把所有东西都传递到主线程。</li>
</ol>


<p>构建并运行你的App。你应该看到在左下方的高/低温度label更新了：</p>

<p><img src="http://cdn3.raywenderlich.com/wp-content/uploads/2013/11/ui-wiring-hilo.jpg" width="320" alt="UI Wiring with Bindings" /></p>

<h2>在Table View中显示数据</h2>

<p>现在，你已经获取所有的数据，你可以在table view中整齐地显示出来。你会在分页的table view中显示最近6小时的每时播报和每日预报。该App会显示三个页面：一个是当前状况，一个是逐时预报，以及一个每日预报。</p>

<p>之前，你可以添加单元格到table view，你需要初始化和配置一些日期格式化。</p>

<p>到<code>WXController.m</code>最顶端的私有接口处，添加下列两个属性</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSDateFormatter</span> <span class="o">*</span><span class="n">hourlyFormatter</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSDateFormatter</span> <span class="o">*</span><span class="n">dailyFormatter</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于创建日期格式化非常昂贵，我们将在init方法中实例化他们，并使用这些变量去存储他们的引用。</p>

<p>还在<code>WXController.m</code>中，添加如下代码到<code>@implementation</code>中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_hourlyFormatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSDateFormatter</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="n">_hourlyFormatter</span><span class="p">.</span><span class="n">dateFormat</span> <span class="o">=</span> <span class="s">@&quot;h a&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">_dailyFormatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSDateFormatter</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="n">_dailyFormatter</span><span class="p">.</span><span class="n">dateFormat</span> <span class="o">=</span> <span class="s">@&quot;EEEE&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>你可能想知道为什么在<code>-init</code>中初始化这些日期格式化，而不是在<code>-viewDidLoad</code>中初始化他们。好问题！</p>

<p>实际上<code>-viewDidLoad</code>可以在一个视图控制器的生命周期中多次调用。 <a href="http://www.rsaunders.co.uk/2012/02/nsdateformatter-are-expensive.html">NSDateFormatter对象的初始化是昂贵的</a>，而将它们放置在你的<code>-init</code>，会确保被你的视图控制器初始化一次。</p>

<p>在<code>WXController.m</code>中，寻找<code>tableView:numberOfRowsInSection：</code>,并用如下代码更换<code>TODO</code>到<code>return</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">section</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">MIN</span><span class="p">([[</span><span class="n">WXManager</span> <span class="n">sharedManager</span><span class="p">].</span><span class="n">hourlyForecast</span> <span class="n">count</span><span class="p">],</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="k">return</span> <span class="n">MIN</span><span class="p">([[</span><span class="n">WXManager</span> <span class="n">sharedManager</span><span class="p">].</span><span class="n">dailyForecast</span> <span class="n">count</span><span class="p">],</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>第一部分是对的逐时预报。使用最近6小时的预预报，并添加了一个作为页眉的单元格。</li>
<li>接下来的部分是每日预报。使用最近6天的每日预报，并添加了一个作为页眉的单元格。</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">注意：您使用表格单元格作为标题，而不是内置的、具有粘性的滚动行为的标题。这个</span><span class="n">table</span> <span class="n">view</span><span class="err">设置了分页，粘性滚动行为看起来会很奇怪。</span>
</span></code></pre></td></tr></table></div></figure>


<p>在<code>WXController.m</code>找到<code>tableView:cellForRowAtIndexPath:</code>,并用如下代码更换<code>TODO</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">indexPath</span><span class="p">.</span><span class="n">section</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="nl">configureHeaderCell:</span><span class="n">cell</span> <span class="nl">title:</span><span class="s">@&quot;Hourly Forecast&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 2</span>
</span><span class='line'>        <span class="n">WXCondition</span> <span class="o">*</span><span class="n">weather</span> <span class="o">=</span> <span class="p">[</span><span class="n">WXManager</span> <span class="n">sharedManager</span><span class="p">].</span><span class="n">hourlyForecast</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="nl">configureHourlyCell:</span><span class="n">cell</span> <span class="nl">weather:</span><span class="n">weather</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">indexPath</span><span class="p">.</span><span class="n">section</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="nl">configureHeaderCell:</span><span class="n">cell</span> <span class="nl">title:</span><span class="s">@&quot;Daily Forecast&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 3</span>
</span><span class='line'>        <span class="n">WXCondition</span> <span class="o">*</span><span class="n">weather</span> <span class="o">=</span> <span class="p">[</span><span class="n">WXManager</span> <span class="n">sharedManager</span><span class="p">].</span><span class="n">dailyForecast</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="nl">configureDailyCell:</span><span class="n">cell</span> <span class="nl">weather:</span><span class="n">weather</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>每个部分的第一行是标题单元格。</li>
<li>获取每小时的天气和使用自定义配置方法配置cell。</li>
<li>获取每天的天气，并使用另一个自定义配置方法配置cell。</li>
</ol>


<p>最后，添加如下代码到<code>WXController.m</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">configureHeaderCell:</span><span class="p">(</span><span class="n">UITableViewCell</span> <span class="o">*</span><span class="p">)</span><span class="nv">cell</span> <span class="nf">title:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">title</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">fontWithName:</span><span class="s">@&quot;HelveticaNeue-Medium&quot;</span> <span class="nl">size:</span><span class="mi">18</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">title</span><span class="p">;</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">detailTextLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">configureHourlyCell:</span><span class="p">(</span><span class="n">UITableViewCell</span> <span class="o">*</span><span class="p">)</span><span class="nv">cell</span> <span class="nf">weather:</span><span class="p">(</span><span class="n">WXCondition</span> <span class="o">*</span><span class="p">)</span><span class="nv">weather</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">fontWithName:</span><span class="s">@&quot;HelveticaNeue-Light&quot;</span> <span class="nl">size:</span><span class="mi">18</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">detailTextLabel</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">fontWithName:</span><span class="s">@&quot;HelveticaNeue-Medium&quot;</span> <span class="nl">size:</span><span class="mi">18</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">hourlyFormatter</span> <span class="nl">stringFromDate:</span><span class="n">weather</span><span class="p">.</span><span class="n">date</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">detailTextLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;%.0f°&quot;</span><span class="p">,</span><span class="n">weather</span><span class="p">.</span><span class="n">temperature</span><span class="p">.</span><span class="n">floatValue</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nl">imageNamed:</span><span class="p">[</span><span class="n">weather</span> <span class="n">imageName</span><span class="p">]];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">imageView</span><span class="p">.</span><span class="n">contentMode</span> <span class="o">=</span> <span class="n">UIViewContentModeScaleAspectFit</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">configureDailyCell:</span><span class="p">(</span><span class="n">UITableViewCell</span> <span class="o">*</span><span class="p">)</span><span class="nv">cell</span> <span class="nf">weather:</span><span class="p">(</span><span class="n">WXCondition</span> <span class="o">*</span><span class="p">)</span><span class="nv">weather</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">fontWithName:</span><span class="s">@&quot;HelveticaNeue-Light&quot;</span> <span class="nl">size:</span><span class="mi">18</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">detailTextLabel</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">fontWithName:</span><span class="s">@&quot;HelveticaNeue-Medium&quot;</span> <span class="nl">size:</span><span class="mi">18</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">dailyFormatter</span> <span class="nl">stringFromDate:</span><span class="n">weather</span><span class="p">.</span><span class="n">date</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">detailTextLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;%.0f° / %.0f°&quot;</span><span class="p">,</span>
</span><span class='line'>                                  <span class="n">weather</span><span class="p">.</span><span class="n">tempHigh</span><span class="p">.</span><span class="n">floatValue</span><span class="p">,</span>
</span><span class='line'>                                  <span class="n">weather</span><span class="p">.</span><span class="n">tempLow</span><span class="p">.</span><span class="n">floatValue</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nl">imageNamed:</span><span class="p">[</span><span class="n">weather</span> <span class="n">imageName</span><span class="p">]];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">imageView</span><span class="p">.</span><span class="n">contentMode</span> <span class="o">=</span> <span class="n">UIViewContentModeScaleAspectFit</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>配置和添加文本到作为section页眉单元格。你会重用此为每日每时的预测部分。</li>
<li>格式化逐时预报的单元格。</li>
<li>格式化每日预报的单元格。</li>
</ol>


<p>构建并运行您的App，尝试滚动你的table view，并&hellip;等一下。什么都没显示！怎么办？</p>

<p>如果你已经使用过的<code>UITableView</code>，可能你之前遇到过问题。这个table没有重新加载！</p>

<p>为了解决这个问题，你需要添加另一个针对每时预报和每日预报属性的ReactiveCocoa观察。</p>

<p>在<code>WXController.m</code>的<code>-viewDidLoad</code>中，添加下列代码到其他ReactiveCocoa观察代码中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[[</span><span class="n">RACObserve</span><span class="p">([</span><span class="n">WXManager</span> <span class="n">sharedManager</span><span class="p">],</span> <span class="n">hourlyForecast</span><span class="p">)</span>
</span><span class='line'>       <span class="nl">deliverOn:</span><span class="n">RACScheduler</span><span class="p">.</span><span class="n">mainThreadScheduler</span><span class="p">]</span>
</span><span class='line'>   <span class="nl">subscribeNext:</span><span class="o">^</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">newForecast</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
</span><span class='line'>   <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'><span class="p">[[</span><span class="n">RACObserve</span><span class="p">([</span><span class="n">WXManager</span> <span class="n">sharedManager</span><span class="p">],</span> <span class="n">dailyForecast</span><span class="p">)</span>
</span><span class='line'>       <span class="nl">deliverOn:</span><span class="n">RACScheduler</span><span class="p">.</span><span class="n">mainThreadScheduler</span><span class="p">]</span>
</span><span class='line'>   <span class="nl">subscribeNext:</span><span class="o">^</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">newForecast</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
</span><span class='line'>   <span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>


<p>构建并运行App；滚动table view，你将看到填充的所有预报数据。</p>

<p><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2013/11/unaligned-heights.jpg" width="320" alt="Forecast with Odd Heights" /></p>

<h2>给你的App添加效果</h2>

<p>本页面为每时和每日预报不会占满整个屏幕。幸运的是，有一个非常简单的修复办法。在本教程前期，您在<code>-viewDidLoad</code>中获得屏幕高度。</p>

<p>在<code>WXController.m</code>中，查找table view的委托方法<code>-tableView:heightForRowAtIndexPath:</code>，并且替换<code>TODO</code>到<code>return</code>的代码:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSInteger</span> <span class="n">cellCount</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">tableView:</span><span class="n">tableView</span> <span class="nl">numberOfRowsInSection:</span><span class="n">indexPath</span><span class="p">.</span><span class="n">section</span><span class="p">];</span>
</span><span class='line'><span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">screenHeight</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">cellCount</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>屏幕高度由一定数量的cell所分割，所以所有cell的总高度等于屏幕的高度。</p>

<p>构建并运行你的App；table view填满了整个屏幕，如下所示：</p>

<p><img src="http://cdn3.raywenderlich.com/wp-content/uploads/2013/11/aligned-heights.jpg" width="320" alt="Forecast with Full Height" /></p>

<p>最后要做的是把我在本教程的第一部分开头提到的模糊效果引入。当你滚动预报页面，模糊效果应该动态显示。</p>

<p>添加下列scroll delegate到<code>WXController.m</code>最底部：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#pragma mark - UIScrollViewDelegate</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">scrollViewDidScroll:</span><span class="p">(</span><span class="n">UIScrollView</span> <span class="o">*</span><span class="p">)</span><span class="nv">scrollView</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">height</span> <span class="o">=</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">position</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">scrollView</span><span class="p">.</span><span class="n">contentOffset</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// 2</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">percent</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">position</span> <span class="o">/</span> <span class="n">height</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// 3</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">blurredImageView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">percent</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>获取滚动视图的高度和内容偏移量。与0偏移量做比较，因此试图滚动table低于初始位置将不会影响模糊效果。</li>
<li>偏移量除以高度，并且最大值为1，所以alpha上限为1。</li>
<li>当你滚动的时候，把结果值赋给模糊图像的alpha属性，来更改模糊图像。</li>
</ol>


<p>构建并运行App，滚动你的table view，并查看这令人惊异的模糊效果：</p>

<p><img src="http://cdn5.raywenderlich.com/wp-content/uploads/2013/11/with-blur.jpg" width="320" alt="Finished Product" /></p>

<h2>何去何从？</h2>

<p>在本教程中你已经完成了很多内容：您使用CocoaPods创建了一个项目，完全用代码书写了一个视图结构，创建数据模型和管理类，并使用函数式编程将他们连接到一起！</p>

<p>您可以从<a href="http://cdn5.raywenderlich.com/wp-content/uploads/2013/11/SimpleWeather-Part-2.zip">这里下载</a>该项目的完成版本。</p>

<p>这个App还有很多酷的东西可以去做。一个好的开始是使用<a href="http://www.flickr.com/services/api/">Flickr API</a>来查找基于设备位置的背景图像。</p>

<p>还有，你的应用程序只处理温度和状态;有什么其他的天气信息能融入你的App？</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/11/yi--ios-7-best-practices-part-1/">[译]iOS7最佳实践：一个天气App案例(一)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-11T22:21:53+08:00" pubdate data-updated="true">Feb 11<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>注：本文译自：<a href="http://www.raywenderlich.com/55384/ios-7-best-practices-part-1">raywenderlich ios-7-best-practices-part-1</a>，去除了跟主题无关的寒暄部分。
欢迎转载，保持署名</p>

<p>在这个两部分的系列教程中，您将探索如何使用以下工具和技术来创建自己的App：</p>

<ul>
<li><a href="http://cocoapods.org/">Cocoapods</a></li>
<li>Manual layout in code(纯代码布局)</li>
<li><a href="https://github.com/ReactiveCocoa/ReactiveCocoa">ReactiveCocoa</a></li>
<li><a href="http://openweathermap.org/">OpenWeatherMap</a></li>
</ul>


<p>本教程专为熟悉基本知识的、但还没有接触到太多高级主题的中级开发者而设计。本教程也是想要去探索Objective-C<a href="http://en.wikipedia.org/wiki/Functional_programming">函数编程</a>一个很好的开始。</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/weather3.gif" alt="Finished Weather App" /></p>

<h2>开始</h2>

<p>打开Xcode并执行<code>File\New\Project</code>。选择<code>Application\Empty Application</code>。将项目命名为<code>SimpleWeather</code>，单击下一步，选择一个目录去保存你的项目，然后点击Create。
现在，你的基础项目已经完成。下一步是集成你的第三方工具。但首先你要<code>关闭Xcode</code>，确保他不会影响下一步。</p>

<h3>Cocoapods</h3>

<p>你将要下载<a href="http://cocoapods.org/">Cocoapods</a>的代码，在Xcode项目中添加文件来使用，并配置项目需要的设置。</p>

<h3>Mantle</h3>

<p><a href="https://github.com/MantleFramework/Mantle">Mantle</a>是由于Github团队开发的，目的是去除Objective-C把JSON数据转为NSObject子类的所有样板代码。Mantle也能做数据转换，通过一种神奇的方式把JSON原始数据(strings, ints, floats)转换为复杂数据，比如NSDate, NSURL, 甚至是自定义类。</p>

<h3>LBBlurredImage</h3>

<p><a href="https://github.com/lukabernardi/LBBlurredImage">LBBlurredImage</a>是一个继承自UIImageView，轻而易举使图像模糊的项目。你将仅仅用一行代码来创建一个神奇的模糊效果。</p>

<h3>TSMessages</h3>

<p><a href="https://github.com/toursprung/TSMessages">TSMessages</a> 是另一个非常简单的库，用来显示浮层警告和通知。当出现错误信息而不直接影响用户的时候，最好使用浮层来代替模态窗口(例如UIAlertView)，这样你将尽可能减少对用户的影响。</p>

<p>你将只用TSMessages，在网络失去连接或API错误的时候。如果发生错误，你将看到类似这样的一个浮层：</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/12/TSMessage.png" alt="TSMessages Error" /></p>

<h3>ReactiveCocoa</h3>

<p>最后，你将使用到<a href="https://github.com/ReactiveCocoa/ReactiveCocoa">ReactiveCocoa</a>，他也来自于GitHub团队。ReactiveCocoa给Objective-C带来了函数编程，类似与.NET的<a href="http://msdn.microsoft.com/en-us/data/gg577609.aspx">Reactive Extensions</a>。你将在第二部分花费大部分时间去实现ReactiveCocoa。</p>

<h2>设置你的Cocoapods</h2>

<p>设置你的Cocoapods，先要确保你已经安装了Cocoapods。为此，打开命令行程序，并输入。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>which pod</span></code></pre></td></tr></table></div></figure>


<p>你将会看到类似这样的输出:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/pod</span></code></pre></td></tr></table></div></figure>


<p>这决定于你如何管理Ruby gems，例如你使用<a href="http://rbenv.org/">rbenv</a>或<a href="http://rvm.io/">RVM</a>,路径可能有所不同。</p>

<p>如果命令行简单的返回提示，或显示<code>pod not found</code>，表示Cocoapods未安装在你的机器上。可以查看我们的<a href="http://www.raywenderlich.com/12139/introduction-to-cocoapods">Cocoapods教程</a>作为安装说明。这也是一个很好的资源，如果你想更多得了解Cocoapods的话。</p>

<p><a href="http://guides.cocoapods.org/syntax/podfile.html">Podfiles</a>是用来告诉Cocoapods哪些开源项目需要导入。</p>

<p>要创建你的第一个Cocoapod，首先在命令行中用<code>cd</code>命令导航到你的XCode项目所在的文件夹，在命令行中启动编辑器，输入</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>platform :ios, '7.0'
</span><span class='line'> 
</span><span class='line'>pod 'Mantle'
</span><span class='line'>pod 'LBBlurredImage'
</span><span class='line'>pod 'TSMessages'
</span><span class='line'>pod 'ReactiveCocoa'</span></code></pre></td></tr></table></div></figure>


<p>这文件做了两件事情：</p>

<ul>
<li>告诉Cocoapods你的目标平台与版本，这里的你目标是iOS 7.0。</li>
<li>列给Cocoapods一个项目所有需要引入和安装的三方库清单。</li>
</ul>


<p>在命令行中输入<code>pod install</code>进行安装。</p>

<p>这可能需要花一到两分钟的时间去安装各种包。你的命令行应该输出如下所示:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pod install
</span><span class='line'>Analyzing dependencies
</span><span class='line'> 
</span><span class='line'>CocoaPods 0.28.0 is available.
</span><span class='line'> 
</span><span class='line'>Downloading dependencies
</span><span class='line'>Installing HexColors (2.2.1)
</span><span class='line'>Installing LBBlurredImage (0.1.0)
</span><span class='line'>Installing Mantle (1.3.1)
</span><span class='line'> 
</span><span class='line'>Installing ReactiveCocoa (2.1.7)
</span><span class='line'>Installing TSMessages (0.9.4)
</span><span class='line'>Generating Pods project
</span><span class='line'>Integrating client project
</span><span class='line'> 
</span><span class='line'>[!] From now on use `SimpleWeather.xcworkspace`.</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sjpsega注:若你之前安装过Cocoapods的话，这里安装报错的话，可以看看http://blog.cocoapods.org/Repairing-Our-Broken-Specs-Repository/ 修复问题</span></code></pre></td></tr></table></div></figure>


<p>Cocoapods会在你的项目目录中创建一堆新文件，但是，只有一个需要你关心，<code>SimpleWeather.xcworkspace</code>。</p>

<p>用Xcode打开<code>SimpleWeather.xcworkspace</code>。看看你的项目设置，现在有一个Pods项目在你的项目工作区，以及在Pods文件夹放着每一个你引入的库，如下所示：</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/12/SimpleWeather-Cocoapods.jpg" alt="Cocoapods Project" /></p>

<p>确保你已经选择SimpleWeather项目，如图所示：
<img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/12/SimpleWeather-Project.jpg" alt="Select SimpleWeather Project" /></p>

<p>构建并运行您的App，以确保一切工作正常：</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/blank-app.jpg" width="320" alt="Blank App" /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>提示：您可能会注意到有一些项目生成警告。因为Cocoapods引入的项目，是由不同的开发者开发，并且不同的开发者对生成警告有不同的态度。通常，你应该可以忽略它们。只要确保没有任何编译器错误！</span></code></pre></td></tr></table></div></figure>


<h2>创建你的主视图控制器</h2>

<p>虽然这个App看起来复杂，但它还会通过一个单一的View Controller完成。现在，你将添加他。</p>

<p>选中<code>SimpleWeather</code>项目，单击<code>File\New\File</code>，并且选择<code>Cocoa Touch\Objective-C class</code>. 命名为<code>WXController</code>，并设置为<code>UIViewController</code>的子类。</p>

<p>确保<code>Targeted for iPad</code>和<code>With XIB for user interface</code>都没有选中，如下图所示：
<img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/create-controller.jpg" alt="Create WXController" /></p>

<p>打开<code>WXController.m</code>然后用如下所示替换<code>-viewDidLoad</code>方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Remove this later</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">redColor</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在打开<code>AppDelegate.m</code>，并且引入如下两个class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#import &quot;WXController.h&quot;</span>
</span><span class='line'><span class="cp">#import &lt;TSMessage.h&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>眼尖的读者会注意到<code>WXController</code>使用引号引入，<code>TSMessage</code>使用单括号引入。</p>

<p>回头看下当你创建Podfile的时候，你使用Cocoapods引入<code>TSMessage</code>。Cocoapods创建TSMessage项目，并把它加入到工作空间。既然你从工作区的其他项目导入，可以使用尖括号代替引号。</p>

<p>代替<code>-application:didFinishLaunchingWithOptions</code>的内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIWindow</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="p">[[</span><span class="n">UIScreen</span> <span class="n">mainScreen</span><span class="p">]</span> <span class="n">bounds</span><span class="p">]];</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="p">[[</span><span class="n">WXController</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">whiteColor</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">window</span> <span class="n">makeKeyAndVisible</span><span class="p">];</span>
</span><span class='line'>    <span class="c1">// 2</span>
</span><span class='line'>    <span class="p">[</span><span class="n">TSMessage</span> <span class="nl">setDefaultViewController:</span> <span class="n">self</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">rootViewController</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>标号注释的解释：</p>

<ol>
<li>初始化并设置<code>WXController</code>实例作为App的根视图控制器。通常这个控制器是一个的<code>UINavigationController</code>或<code>UITabBarController</code>，但在当前情况下，你使用<code>WXController</code>的单个实例。</li>
<li>设置默认的视图控制器来显示你的TSMessages。这样做，你将不再需要手动指定要使用的控制器来显示警告。</li>
</ol>


<p>构建并运行，看看你的新视图控制器起作用了。</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/wxcontroller-red.jpg" width="320" alt="WXController" /></p>

<p>在红色背景下，状态栏有点不够清晰。幸运的是，有一个简单的方法，使状态栏更清晰易读。</p>

<p>在iOS7，<a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIViewController_Class/Reference/Reference.html#//apple_ref/occ/instm/UIViewController/preferredStatusBarStyle">UIViewController</a>有一个新的API，用来控制状态栏的外观。打开<code>WXController</code>，直接添加下面的代码到<code>-viewDidLoad:</code>方法下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">UIStatusBarStyle</span><span class="p">)</span><span class="nf">preferredStatusBarStyle</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">UIStatusBarStyleLightContent</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>再次构建并运行，你将看到状态栏如下的变化:</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/wxcontroller-red-status.jpg" width="320" alt="Create WXController with Light Status Bar" /></p>

<h2>设置你的App视图</h2>

<p>现在是时候让你的App接近生活。下载这个项目的<a href="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/Images.zip">图片</a>，并解压缩到一个合适的位置。这个压缩包的背景图片出自Flickr用户<a href="http://www.flickr.com/photos/52547323@N00/5637648252">idleformat</a>之手，天气图片出自Dribbble用户<a href="http://dribbble.com/shots/1247177-Weather-icons?list=users">heeyeun</a>之手。</p>

<p>切换回Xcode，单击<code>File\Add Files to “SimpleWeather”</code>&hellip;.定位到你刚刚解压缩的图片文件夹并选择它。选择<code>Copy items into destination group’s folder (if needed)</code>，然后单击<code>Add</code>。</p>

<p>打开<code>WXController.h</code>, 添加如下委托协议：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="o">&lt;</span><span class="n">UITableViewDataSource</span><span class="p">,</span> <span class="n">UITableViewDelegate</span><span class="p">,</span> <span class="n">UIScrollViewDelegate</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在打开<code>WXController.m</code>。 小提示：你可以使用<code>Control-Command-Up</code>的快捷键来实现<code>.h</code>和<code>.m</code>文件之间的快速切换。</p>

<p>添加如下代码到<code>WXController.m</code>顶部:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#import &lt;LBBlurredImage/UIImageView+LBBlurredImage.h&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>LBBlurredImage.h</code>包含在Cocoapods引入的<code>LBBlurredImage</code>项目，你会使用这个库来模糊背景图片。</p>

<p>应该有一个空的私有接口样板在<code>WXController</code> imports的下方。它具有以下属性：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">WXController</span> <span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UIImageView</span> <span class="o">*</span><span class="n">backgroundImageView</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UIImageView</span> <span class="o">*</span><span class="n">blurredImageView</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UITableView</span> <span class="o">*</span><span class="n">tableView</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="n">CGFloat</span> <span class="n">screenHeight</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在，是时候在项目中创建并设置视图。</p>

<p>下面是你App的分解图，记住，table view将是透明的：</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/screens.jpg" alt="Exploded Screens" /></p>

<p>为了实现动态模糊效果，在你的App中，你会根据App的滚动来改变模糊图像的alpha值。</p>

<p>打开<code>WXController.m</code>，使用如下代码来，替换掉<code>-viewDidLoad</code>中设置背景色的代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">screenHeight</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIScreen</span> <span class="n">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">UIImage</span> <span class="o">*</span><span class="n">background</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nl">imageNamed:</span><span class="s">@&quot;bg&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">backgroundImageView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImageView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithImage:</span><span class="n">background</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">backgroundImageView</span><span class="p">.</span><span class="n">contentMode</span> <span class="o">=</span> <span class="n">UIViewContentModeScaleAspectFill</span><span class="p">;</span>
</span><span class='line'><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="nl">addSubview:</span><span class="n">self</span><span class="p">.</span><span class="n">backgroundImageView</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">blurredImageView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImageView</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">blurredImageView</span><span class="p">.</span><span class="n">contentMode</span> <span class="o">=</span> <span class="n">UIViewContentModeScaleAspectFill</span><span class="p">;</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">blurredImageView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">blurredImageView</span> <span class="nl">setImageToBlur:</span><span class="n">background</span> <span class="nl">blurRadius:</span><span class="mi">10</span> <span class="nl">completionBlock:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="nl">addSubview:</span><span class="n">self</span><span class="p">.</span><span class="n">blurredImageView</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 4</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">tableView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UITableView</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">separatorColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nl">colorWithWhite:</span><span class="mi">1</span> <span class="nl">alpha:</span><span class="mf">0.2</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">pagingEnabled</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="nl">addSubview:</span><span class="n">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是非常简单的代码：</p>

<ol>
<li>获取并存储屏幕高度。之后，你将在用分页的方式来显示所有天气​​数据时，使用它。</li>
<li>创建一个静态的背景图，并添加到视图上。</li>
<li>使用LBBlurredImage来创建一个模糊的背景图像，并设置alpha为0，使得开始<code>backgroundImageView</code>是可见的。</li>
<li>创建tableview来处理所有的数据呈现。 设置WXController为delegate和dataSource，以及滚动视图的delegate。请注意，设置<code>pagingEnabled</code>为<code>YES</code>。</li>
</ol>


<p>添加如下UITableView的delegate和dataSource的代码到<code>WXController.m</code>的<code>@implementation</code>块中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="cp">#pragma mark - UITableViewDataSource</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nf">numberOfSectionsInTableView:</span><span class="p">(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="nf">numberOfRowsInSection:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">section</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// TODO: Return count of forecast</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">UITableViewCell</span> <span class="o">*</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="nf">cellForRowAtIndexPath:</span><span class="p">(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">CellIdentifier</span> <span class="o">=</span> <span class="s">@&quot;CellIdentifier&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">UITableViewCell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">tableView</span> <span class="nl">dequeueReusableCellWithIdentifier:</span><span class="n">CellIdentifier</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">cell</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">cell</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UITableViewCell</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithStyle:</span><span class="n">UITableViewCellStyleValue1</span> <span class="nl">reuseIdentifier:</span><span class="n">CellIdentifier</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 3</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">selectionStyle</span> <span class="o">=</span> <span class="n">UITableViewCellSelectionStyleNone</span><span class="p">;</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nl">colorWithWhite:</span><span class="mi">0</span> <span class="nl">alpha:</span><span class="mf">0.2</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="p">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">whiteColor</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">detailTextLabel</span><span class="p">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">whiteColor</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// TODO: Setup the cell</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">cell</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark - UITableViewDelegate</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="nf">heightForRowAtIndexPath:</span><span class="p">(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// TODO: Determine cell height based on screen</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">44</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li><code>Pragma mark</code>是<a href="http://nshipster.com/pragma/">组织代码</a>的很好的一种方式。</li>
<li>你的table view有两个部分，一个是每小时的天气预报，另一个用于每日播报。table view的section数目，设置为2。</li>
<li>天气预报的cell是不可选择的。给他们一个半透明的黑色背景和白色文字。</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">注意：使用格式化的注释</span> <span class="c1">// TODO：可以帮助Xcode找到需要以后完成的代码。你还可以使用 Show Document Items(Control-6)来查看TODO项。</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后，添加如下代码到<code>WXController.m</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewWillLayoutSubviews</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">super</span> <span class="n">viewWillLayoutSubviews</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CGRect</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">backgroundImageView</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">;</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">blurredImageView</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">;</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在<code>WXController.m</code>中，你的视图控制器调用该方法来编排其子视图。</p>

<p>构建并运行你的App，看看你的视图如何堆叠。</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/11/background.jpg" width="320" alt="Image Background" /></p>

<p>仔细看，你会看到所有空的table cell的cell分隔线。</p>

<p>仍然在<code>-viewDidLoad</code>中，添加下面的代码来设置你的布局框架和边距：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="n">CGRect</span> <span class="n">headerFrame</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIScreen</span> <span class="n">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">;</span>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="n">CGFloat</span> <span class="n">inset</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'><span class="n">CGFloat</span> <span class="n">temperatureHeight</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
</span><span class='line'><span class="n">CGFloat</span> <span class="n">hiloHeight</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
</span><span class='line'><span class="n">CGFloat</span> <span class="n">iconHeight</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
</span><span class='line'><span class="c1">// 4</span>
</span><span class='line'><span class="n">CGRect</span> <span class="n">hiloFrame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="n">inset</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">headerFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">hiloHeight</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">headerFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">inset</span><span class="p">),</span>
</span><span class='line'>                              <span class="n">hiloHeight</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">CGRect</span> <span class="n">temperatureFrame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="n">inset</span><span class="p">,</span>
</span><span class='line'>                                     <span class="n">headerFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="p">(</span><span class="n">temperatureHeight</span> <span class="o">+</span> <span class="n">hiloHeight</span><span class="p">),</span>
</span><span class='line'>                                     <span class="n">headerFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">inset</span><span class="p">),</span>
</span><span class='line'>                                     <span class="n">temperatureHeight</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">CGRect</span> <span class="n">iconFrame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="n">inset</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">temperatureFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">iconHeight</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">iconHeight</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">iconHeight</span><span class="p">);</span>
</span><span class='line'><span class="c1">// 5</span>
</span><span class='line'><span class="n">CGRect</span> <span class="n">conditionsFrame</span> <span class="o">=</span> <span class="n">iconFrame</span><span class="p">;</span>
</span><span class='line'><span class="n">conditionsFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="p">(((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">inset</span><span class="p">)</span> <span class="o">+</span> <span class="n">iconHeight</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'><span class="n">conditionsFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">iconFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">iconHeight</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是相当常规设置代码，但这里是怎么回事：</p>

<ol>
<li>设置table的header大小与屏幕相同。你将利用的UITableView的分页来分隔页面页头和每日每时的天气预报部分。</li>
<li>创建inset（或padding）变量，以便您的所有标签均匀分布并居中。</li>
<li>创建并初始化为各种视图创建的高度变量。设置这些值作为常量，使得可以很容易地在需要的时候，配置和更改您的视图设置。</li>
<li>使用常量和inset变量，为label和view创建框架。</li>
<li>复制图标框，调整它，使文本具有一定的扩展空间，并将其移动到该图标的右侧。当我们把标签添加到视图，你会看到布局的效果。</li>
</ol>


<p>添加如下代码到<code>-viewDidLoad</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="n">UIView</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">headerFrame</span><span class="p">];</span>
</span><span class='line'><span class="n">header</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">tableHeaderView</span> <span class="o">=</span> <span class="n">header</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="c1">// bottom left</span>
</span><span class='line'><span class="n">UILabel</span> <span class="o">*</span><span class="n">temperatureLabel</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UILabel</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">temperatureFrame</span><span class="p">];</span>
</span><span class='line'><span class="n">temperatureLabel</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">];</span>
</span><span class='line'><span class="n">temperatureLabel</span><span class="p">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">whiteColor</span><span class="p">];</span>
</span><span class='line'><span class="n">temperatureLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@&quot;0°&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">temperatureLabel</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">fontWithName:</span><span class="s">@&quot;HelveticaNeue-UltraLight&quot;</span> <span class="nl">size:</span><span class="mi">120</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">header</span> <span class="nl">addSubview:</span><span class="n">temperatureLabel</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// bottom left</span>
</span><span class='line'><span class="n">UILabel</span> <span class="o">*</span><span class="n">hiloLabel</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UILabel</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">hiloFrame</span><span class="p">];</span>
</span><span class='line'><span class="n">hiloLabel</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">];</span>
</span><span class='line'><span class="n">hiloLabel</span><span class="p">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">whiteColor</span><span class="p">];</span>
</span><span class='line'><span class="n">hiloLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@&quot;0° / 0°&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">hiloLabel</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">fontWithName:</span><span class="s">@&quot;HelveticaNeue-Light&quot;</span> <span class="nl">size:</span><span class="mi">28</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">header</span> <span class="nl">addSubview:</span><span class="n">hiloLabel</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// top</span>
</span><span class='line'><span class="n">UILabel</span> <span class="o">*</span><span class="n">cityLabel</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UILabel</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">30</span><span class="p">)];</span>
</span><span class='line'><span class="n">cityLabel</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">];</span>
</span><span class='line'><span class="n">cityLabel</span><span class="p">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">whiteColor</span><span class="p">];</span>
</span><span class='line'><span class="n">cityLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@&quot;Loading...&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">cityLabel</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">fontWithName:</span><span class="s">@&quot;HelveticaNeue-Light&quot;</span> <span class="nl">size:</span><span class="mi">18</span><span class="p">];</span>
</span><span class='line'><span class="n">cityLabel</span><span class="p">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="n">NSTextAlignmentCenter</span><span class="p">;</span>
</span><span class='line'><span class="p">[</span><span class="n">header</span> <span class="nl">addSubview:</span><span class="n">cityLabel</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="n">UILabel</span> <span class="o">*</span><span class="n">conditionsLabel</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UILabel</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">conditionsFrame</span><span class="p">];</span>
</span><span class='line'><span class="n">conditionsLabel</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">];</span>
</span><span class='line'><span class="n">conditionsLabel</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">fontWithName:</span><span class="s">@&quot;HelveticaNeue-Light&quot;</span> <span class="nl">size:</span><span class="mi">18</span><span class="p">];</span>
</span><span class='line'><span class="n">conditionsLabel</span><span class="p">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">whiteColor</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">header</span> <span class="nl">addSubview:</span><span class="n">conditionsLabel</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'><span class="c1">// bottom left</span>
</span><span class='line'><span class="n">UIImageView</span> <span class="o">*</span><span class="n">iconView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImageView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">iconFrame</span><span class="p">];</span>
</span><span class='line'><span class="n">iconView</span><span class="p">.</span><span class="n">contentMode</span> <span class="o">=</span> <span class="n">UIViewContentModeScaleAspectFit</span><span class="p">;</span>
</span><span class='line'><span class="n">iconView</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">header</span> <span class="nl">addSubview:</span><span class="n">iconView</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是相当长的一块代码，但它真的只是在做设置各种控件的繁重工作。简单的说：</p>

<ol>
<li>设置当前view为你的table header。</li>
<li>构建每一个显示气象数据的标签。</li>
<li>添加一个天气图标的图像视图。</li>
</ol>


<p>构建并运行你的App，你应该可以看到你之前布局的所有所有view。下面的屏幕截图显示了使用手工布局的、所有标签框在视觉上的显示。</p>

<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/12/built-layout.jpg" width="500" alt="Labels and Views" /></p>

<p>用手指轻轻推动table，当你滚动它的时候，应该会反弹。</p>

<h2>获取气象数据</h2>

<p>你会注意到，App显示“Loading&hellip;”，但它不是真正地在工作。是时候获取一些真正的天气数据。</p>

<p>你会从<a href="http://openweathermap.org/">OpenWeatherMap</a>的API拉取数据。 OpenWeatherMap是一个非常棒的服务，旨在提供实时，准确，免费的天气数据给任何人。虽然有很多天气API，但他们大多要么使用较旧的数据格式，如XML，或是有偿服务 &ndash; 并且有时还相当昂贵。</p>

<p>你会遵循以下基本步骤，来获你设备的位置的气象数据：</p>

<ol>
<li>找到设备的位置</li>
<li>从<a href="http://api.openweathermap.org/data/2.5/weather?lat=37.785834&amp;lon=-122.406417&amp;units=imperial">API端</a>下载JSON数据</li>
<li>映射JSON到<code>WXConditions</code>和<code>WXDailyForecasts</code></li>
<li>告诉UI有新数据了</li>
</ol>


<p>开始创建你的天气模型和数据管理类。单击<code>File\New\File…</code>并选择<code>Cocoa Touch\Objective-C class</code>。命名为<code>WXClient</code>并使其为<code>NSObject</code>的子类。</p>

<p>这样再做三次创建以下类：</p>

<ul>
<li><code>WXManager</code>作为<code>NSObject</code>的子类</li>
<li><code>WXCondition</code>作为<code>MTLModel</code>的子类</li>
<li><code>WXDailyForecast</code>作为<code>WXCondition</code>的子类</li>
</ul>


<p>全部完成？现在，你可以开始下一节，其中涉及映射和转换您的天气数据。</p>

<h2>创建你的天气模型</h2>

<p>你的模型将使用<a href="https://github.com/github/Mantle">Mantle</a>，这使得数据映射和转型非常简单。</p>

<p>打开<code>WXCondition.h</code>如下列代码，修改接口：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="k">@interface</span> <span class="nc">WXCondition</span> : <span class="nc">MTLModel</span> <span class="o">&lt;</span><span class="n">MTLJSONSerializing</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSDate</span> <span class="o">*</span><span class="n">date</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSNumber</span> <span class="o">*</span><span class="n">humidity</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSNumber</span> <span class="o">*</span><span class="n">temperature</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSNumber</span> <span class="o">*</span><span class="n">tempHigh</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSNumber</span> <span class="o">*</span><span class="n">tempLow</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">locationName</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSDate</span> <span class="o">*</span><span class="n">sunrise</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSDate</span> <span class="o">*</span><span class="n">sunset</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">conditionDescription</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">condition</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSNumber</span> <span class="o">*</span><span class="n">windBearing</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSNumber</span> <span class="o">*</span><span class="n">windSpeed</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">icon</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">imageName</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li><code>MTLJSONSerializing</code>协议告诉Mantle序列化该对象如何从JSON映射到Objective-C的属性。</li>
<li>这些都是你的天气数据的属性。你将会使用这些属性的get set方法，但是当你要扩展App，这是一种很好的方法来访问数据。</li>
<li>这是一个简单的辅助方法，从天气状况映射到图像文件。</li>
</ol>


<p>构建并运行App。失败了……</p>

<p>原因是你没有从你的Cocoapods项目中引入<code>Mantle</code>。解决方法是，在<code>WXCondition.h</code>中，你需要把<code>MTLModel.h</code>替换为<code>#import &lt;Mantle.h&gt;</code>。</p>

<p>现在构建并运行App。成功了。你会看到一些新的警告，但你可以忽略他们。</p>

<p>首先，你需要处理未实现的<code>-imageName</code>方法。</p>

<p>打开<code>WXCondition.m</code>，添加如下方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nf">imageMap</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">_imageMap</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">_imageMap</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 2</span>
</span><span class='line'>        <span class="n">_imageMap</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span>
</span><span class='line'>                      <span class="s">@&quot;01d&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-clear&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;02d&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-few&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;03d&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-few&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;04d&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-broken&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;09d&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-shower&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;10d&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-rain&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;11d&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-tstorm&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;13d&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-snow&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;50d&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-mist&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;01n&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-moon&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;02n&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-few-night&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;03n&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-few-night&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;04n&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-broken&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;09n&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-shower&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;10n&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-rain-night&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;11n&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-tstorm&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;13n&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-snow&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">@&quot;50n&quot;</span> <span class="o">:</span> <span class="s">@&quot;weather-mist&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="p">};</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_imageMap</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">imageName</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">WXCondition</span> <span class="n">imageMap</span><span class="p">][</span><span class="n">self</span><span class="p">.</span><span class="n">icon</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>创建一个静态的NSDictionary，因为WXCondition的每个实例都将使用相同的数据映射。</li>
<li>天气状况与图像文件的关系（例如“01d”代表“weather-clear.png”）。</li>
<li>声明获取图像文件名的公有方法。</li>
</ol>


<p>看一看从OpenWeatherMap返回的JSON响应数据：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;dt&quot;</span><span class="p">:</span> <span class="mi">1384279857</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">5391959</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;humidity&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;pressure&quot;</span><span class="p">:</span> <span class="mi">1025</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;temp&quot;</span><span class="p">:</span> <span class="mf">62.29</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;temp_max&quot;</span><span class="p">:</span> <span class="mf">69.01</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;temp_min&quot;</span><span class="p">:</span> <span class="mf">57.2</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;San Francisco&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;weather&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;haze&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;icon&quot;</span><span class="p">:</span> <span class="s2">&quot;50d&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">721</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;Haze&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>你需要把嵌套的JSON值映射到Objective-C的属性。嵌套的JSON值是元素，如温度，即上面看到的<code>main</code>节点。</p>

<p>要做到这一点，你将利用的Objective-C的<a href="https://developer.apple.com/library/ios/documentation/cocoa/conceptual/KeyValueCoding/Articles/BasicPrinciples.html">Key-Value Coding</a>和Mantle<a href="https://github.com/MantleFramework/Mantle/blob/master/Mantle/MTLJSONAdapter.h">的MTLJSONAdapter</a>。</p>

<p>还在<code>WXCondition.m</code>，通过添加<code>+JSONKeyPathsByPropertyKey</code>方法，“JSON到模型属性”的映射，且该方法是<code>MTLJSONSerializing</code>协议的<a href="https://github.com/MantleFramework/Mantle/blob/master/Mantle/MTLJSONAdapter.h#L17-28">require</a>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nf">JSONKeyPathsByPropertyKey</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="err">@</span><span class="p">{</span>
</span><span class='line'>             <span class="s">@&quot;date&quot;</span><span class="o">:</span> <span class="s">@&quot;dt&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;locationName&quot;</span><span class="o">:</span> <span class="s">@&quot;name&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;humidity&quot;</span><span class="o">:</span> <span class="s">@&quot;main.humidity&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;temperature&quot;</span><span class="o">:</span> <span class="s">@&quot;main.temp&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;tempHigh&quot;</span><span class="o">:</span> <span class="s">@&quot;main.temp_max&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;tempLow&quot;</span><span class="o">:</span> <span class="s">@&quot;main.temp_min&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;sunrise&quot;</span><span class="o">:</span> <span class="s">@&quot;sys.sunrise&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;sunset&quot;</span><span class="o">:</span> <span class="s">@&quot;sys.sunset&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;conditionDescription&quot;</span><span class="o">:</span> <span class="s">@&quot;weather.description&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;condition&quot;</span><span class="o">:</span> <span class="s">@&quot;weather.main&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;icon&quot;</span><span class="o">:</span> <span class="s">@&quot;weather.icon&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;windBearing&quot;</span><span class="o">:</span> <span class="s">@&quot;wind.deg&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="s">@&quot;windSpeed&quot;</span><span class="o">:</span> <span class="s">@&quot;wind.speed&quot;</span>
</span><span class='line'>             <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在这个方法里，dictionary的key是<code>WXCondition</code>的属性名称，而dictionary的value是JSON的路径。</p>

<p>您可能已经注意到，这里有一个从JSON数据映射到Objective-C属性的问题。属性<code>date</code>是<code>NSDate</code>类型的，但JSON有一个Unix时间类型(sjpsega注:即从1970年1月1日0时0分0秒起至现在的总秒数)的NSInteger值。你需要完成两者之间的转换。</p>

<p>Mantle正好有一个功能来为你解决这个问题：<a href="https://github.com/github/Mantle/blob/master/Mantle/MTLValueTransformer.h">MTLValueTransformer</a>。这个类允许你声明一个block，详细说明值的相互转换。</p>

<p>Mantle的转换器语法有点怪。要创建一个为一个特定属性的转换器，，您可以添加一个以属性名开头和<code>JSONTransformer</code>结尾的类方法。
可能看实际代码比试图解释它更容易理解，所以在<code>WXCondition.m</code>中添加以下为NSDate属性设置的转换器。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSValueTransformer</span> <span class="o">*</span><span class="p">)</span><span class="nf">dateJSONTransformer</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">MTLValueTransformer</span> <span class="nl">reversibleTransformerWithForwardBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">NSDate</span> <span class="nl">dateWithTimeIntervalSince1970:</span><span class="n">str</span><span class="p">.</span><span class="n">floatValue</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">reverseBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSDate</span> <span class="o">*</span><span class="n">date</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;%f&quot;</span><span class="p">,[</span><span class="n">date</span> <span class="n">timeIntervalSince1970</span><span class="p">]];</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSValueTransformer</span> <span class="o">*</span><span class="p">)</span><span class="nf">sunriseJSONTransformer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">self</span> <span class="n">dateJSONTransformer</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSValueTransformer</span> <span class="o">*</span><span class="p">)</span><span class="nf">sunsetJSONTransformer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">self</span> <span class="n">dateJSONTransformer</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>使用blocks做属性的转换的工作，并返回一个MTLValueTransformer返回值。</li>
<li>您只需要详细说明Unix时间和NSDate之间进行转换一次，就可以重用<code>-dateJSONTransformer</code>方法为sunrise和sunset属性做转换。</li>
</ol>


<p>下一个值转型有点讨厌，但它只是使用OpenWeatherMap的API，并自己的格式化JSON响应方式的结果。<code>weather</code>键对应的值是一个JSON数组，但你只关注单一的天气状况。</p>

<p>在<code>WXCondition.m</code>中，使用<code>dateJSONTransformer</code>相同的结构，您可以创建一个NSArray和NSString的之间的转换。该解决方案提供如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSValueTransformer</span> <span class="o">*</span><span class="p">)</span><span class="nf">conditionDescriptionJSONTransformer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">MTLValueTransformer</span> <span class="nl">reversibleTransformerWithForwardBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">values</span> <span class="n">firstObject</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">reverseBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="err">@</span><span class="p">[</span><span class="n">str</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSValueTransformer</span> <span class="o">*</span><span class="p">)</span><span class="nf">conditionJSONTransformer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">self</span> <span class="n">conditionDescriptionJSONTransformer</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSValueTransformer</span> <span class="o">*</span><span class="p">)</span><span class="nf">iconJSONTransformer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">self</span> <span class="n">conditionDescriptionJSONTransformer</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后的转换器只是为了格式化。 OpenWeatherAPI使用每秒/米的风速。由于您的App使用英制系统，你需要将其转换为每小时/英里。</p>

<p>在<code>WXCondition.m</code>的实现中添加以下转换器的方法和宏定义。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#define MPS_TO_MPH 2.23694f</span>
</span><span class='line'>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSValueTransformer</span> <span class="o">*</span><span class="p">)</span><span class="nf">windSpeedJSONTransformer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">MTLValueTransformer</span> <span class="nl">reversibleTransformerWithForwardBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="err">@</span><span class="p">(</span><span class="n">num</span><span class="p">.</span><span class="n">floatValue</span><span class="o">*</span><span class="n">MPS_TO_MPH</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">reverseBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="err">@</span><span class="p">(</span><span class="n">speed</span><span class="p">.</span><span class="n">floatValue</span><span class="o">/</span><span class="n">MPS_TO_MPH</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在OpenWeatherMap的API中有一个小的差异，你必须处理。看一看在位于<a href="http://api.openweathermap.org/data/2.5/weather?lat=37.785834&amp;lon=-122.406417&amp;units=imperial">当前状况的响应</a>和<a href="http://api.openweathermap.org/data/2.5/forecast/daily?lat=37.785834&amp;lon=-122.406417&amp;units=imperial&amp;cnt=7">每日预测反应</a>之间的温度：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">//</span> <span class="err">current</span>
</span><span class='line'><span class="s2">&quot;main&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;grnd_level&quot;</span><span class="p">:</span> <span class="mf">1021.87</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;humidity&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;pressure&quot;</span><span class="p">:</span> <span class="mf">1021.87</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;sea_level&quot;</span><span class="p">:</span> <span class="mf">1030.6</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;temp&quot;</span><span class="p">:</span> <span class="mf">58.09</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;temp_max&quot;</span><span class="p">:</span> <span class="mf">58.09</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;temp_min&quot;</span><span class="p">:</span> <span class="mf">58.09</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="err">//</span> <span class="err">daily</span> <span class="err">forecast</span>
</span><span class='line'><span class="s2">&quot;temp&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;day&quot;</span><span class="p">:</span> <span class="mf">58.14</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;eve&quot;</span><span class="p">:</span> <span class="mf">58.14</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;max&quot;</span><span class="p">:</span> <span class="mf">58.14</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;min&quot;</span><span class="p">:</span> <span class="mf">57.18</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;morn&quot;</span><span class="p">:</span> <span class="mf">58.14</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;night&quot;</span><span class="p">:</span> <span class="mf">57.18</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>current</code>的第一个key是<code>main</code>，最高温度存储在key <code>temp_max</code>中，而<code>daily forecast</code>的第一个key是<code>temp</code>，最高温度存储在key <code>max</code>中。</p>

<p>key Temperature的差异放在一边，其他都一样。所以，你真正需要做的是修改daily forecasts的键映射。</p>

<p>打开<code>WXDailyForecast.m</code>重写<code>+JSONKeyPathsByPropertyKey</code>方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nf">JSONKeyPathsByPropertyKey</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">paths</span> <span class="o">=</span> <span class="p">[[</span><span class="n">super</span> <span class="n">JSONKeyPathsByPropertyKey</span><span class="p">]</span> <span class="n">mutableCopy</span><span class="p">];</span>
</span><span class='line'>    <span class="c1">// 2</span>
</span><span class='line'>    <span class="n">paths</span><span class="p">[</span><span class="s">@&quot;tempHigh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">@&quot;temp.max&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">paths</span><span class="p">[</span><span class="s">@&quot;tempLow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">@&quot;temp.min&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// 3</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">paths</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>获取<code>WXCondition</code>的映射，并创建它的可变副本。</li>
<li>你需要为daily forecast做的是改变max和min键映射。</li>
<li>返回新的映射。</li>
</ol>


<p>构建并运行您的App，看起来和上次运行没什么改变，但好的一点是，App编译和运行没有任何错误。</p>

<p><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2013/11/built-layout.jpg" width="320" alt="Labels and Views" /></p>

<h2>何去何从？</h2>

<p>你可以从<a href="http://cdn4.raywenderlich.com/wp-content/uploads/2013/11/SimpleWeather-Part-1.zip">这里</a>下载完整程序。</p>

<p>在这部分教程中，您使用Cocoapods设置项目，增加视图到控制器，编排视图，并建立模型来反映你抓取的气象数据。该App还没有充分发挥作用，但是你成功用纯代码创建视图，并学习了如何使用Mantle映射和转换JSON数据。</p>

<p>接下来看看<a href="/blog/2014/02/15/yi--ios-7-best-practices-part-2/">教程的第二部分</a>，你将充实你的App，从weather API获取数据，并在UI上显示。您将使用新的iOS7 <a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSURLSession_class/Introduction/Introduction.html">NSURLSession</a>去下载数据，以及使用<code>ReactiveCocoa</code>把位置查找，天气数据抓取和UI更新事件绑在一起。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/06/kai-shi-xie-blog/">开始写Blog</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-06T16:31:07+08:00" pubdate data-updated="true">Feb 6<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>趁着春节假期，花了点时间，在github上用<a href="http://octopress.org/">Octopress</a>搭了个个人Blog。希望自己新的一年，能写点技术Blog，多做积累，锻炼文字。</p>

<p>其实以前在javaeye上也写过技术Blog，但是写得不多。在Sohu上写自己的生活Blog，写的蛮多的，现在渐渐也写得少了。</p>

<p>javaeye的Blog有个最大的缺点：编辑器不好用，生成的文章格式不好看，特别是代码块，特别难看。而且添加代码demo更加麻烦，需要上传，且不便于后期的维护与管理。</p>

<p>自己搭建Blog的话，javaeye的编辑器这个缺点就不存在了，而且使用MarkDown格式写文章，很方便，很轻松就能写出格式优美的文章了。而且放在github上，更不用怕文章丢失的问题了，哈哈。</p>

<p>当然自己搭建Blog的最大缺点是，流量少，缺少流量，缺少讨论；当然这个也不重要，重要的是自己的积累，如果自己写得好，肯定会有人看到的。</p>

<p>刚入门<a href="http://octopress.org/">Octopress</a>，定制化蛮强的，还要好好研究下。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/30/2013summer/">2013年终总结</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-30T22:09:20+08:00" pubdate data-updated="true">Jan 30<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2013已经过去，先总结下去年的目标与主要的事：</h2>

<ul>
<li>花血本买了mac，开发用mac就是爽，很纯粹；</li>
<li>买了5S，为了不换号码上4G;</li>
<li>3月份当上了爸爸，有了一个健健康康的儿子，养孩子真不容易，好累！感谢比我更累的是我老婆。我还不是个好爸爸，陪儿子的时间不多。快到年底时，不小心又弄出了条人命，因为老婆身体素质不够好，感冒了近一个月，只能作罢…苦了老婆…</li>
<li>js没有深入学习，很肤浅，还是基于业务层面的开发</li>
<li>开发了一个App，登录了AppStore，虽然下载量不高，但还是很让人高兴的；</li>
<li>没有去学习Ruby这样的新语言，为了开发App，学习了Object-C；</li>
<li>BeeChart开源了，但只局限于开源了，现在js的图表越来越流行了，flash的图表意义不大了，不会去优化了吧；</li>
<li>因为个人关系，换了部门，原先采购业务部门太业务了，觉得在那里意义不大，更想做移动方面的开发；换到了旺铺，希望能好好工作，提高自己的能力，发挥所长。</li>
</ul>


<p>总得来说去年的目标完成的非常不错，完成了90%，来年要继续努力啊。</p>

<h2>想想2014要做的</h2>

<ul>
<li>继续好好学习OC，开发至少一款新应用登录AppStore；</li>
<li>继续努力当个好爸爸，教孩子走路说话，多陪陪孩子；还要努力当个好老公…</li>
<li>在Github上开个blog，写写技术文章与总结，希望一年至少12篇，一个月一篇吧；</li>
<li>好好工作，收入上能再提高30%。</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/09/2012summary/">2012年终总结</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-09T20:45:29+08:00" pubdate data-updated="true">Feb 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>时间真快，一年的时间就这么过去了，当然每年过年的时候，都感觉时间过得好快，一年就这么没了。
过去自己也没总结的习惯，这个习惯不好，该改一改了，总结过去，憧憬未来。</p>

<h2>2012的主要事情</h2>

<ul>
<li>结婚。3.30完成了终身大事。每天晚上家里多了个等我回家的人。</li>
<li>因为公司部门调整的缘故，我的工作重心也从AS转到了JS，负责了中文站首页的工作，初始压力很大，虽然看过书，但没实践经验，就怕搞砸了。还好在毛哥的指导下，顺利完成了任务，做完了2012版本的首页工作。年前又完成了2013的改版。</li>
<li>为了玩《暗黑3》升级了电脑，买了显卡、电源，从5月中旬游戏发售，一直浑浑噩噩玩到了10月国庆前。游戏还是那个游戏，但人不是那个时候的人了。《暗黑2》对我初中时期影响太大了，因为他，我带上了眼镜。但游戏类型对我现在的我来说不太感冒了，小时候特别钟爱的RPG现在也不爱玩了，太费时间了。玩了4个多月，和同事们一起玩，很开心。后来就慢慢累了，一段时间不玩，发条松了，没动力玩了……</li>
<li>结婚后，出乎意料，老婆怀上了……在这里得跟老婆说声对不起，自己自制力较差，睡得比较晚，经常拖的老婆到11点，甚至12点才睡，对孕妇来说，太晚睡了……</li>
<li>抛弃黑莓8700，投入了Andorid的怀抱……</li>
<li>爷爷去世……</li>
</ul>


<p>没了吧，脑子里没有印象深的事情了……</p>

<h2>2013展望/想做的事</h2>

<ul>
<li>买台Mac Pro，都说mac/Linux是程序员使用的系统，想买台用用。</li>
<li>3月底是老婆的预产期，要当爸爸了，努力当个负责的好爸爸。</li>
<li>深入学习JS，jQuery、node等，要知其然知其所以然。</li>
<li>学习移动开发，phoneGap、andorid或iPhone原生开发，期望做出一个有趣的小项目，未来是移动的时代。</li>
<li>想学习一门新的语言，期望是Ruby，让自己的知识更全面一些。</li>
<li>BeeChart开源。网站、编辑器完成了大半，本来期望2.14开源，在项目2周年的日子。过年时间不好控制，估计会稍许延期。开源后的RoadMap不清晰，先开源了吧……</li>
</ul>


<p>差不多了，事情已经蛮多了，看来年能完成几件。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/02/15/yi--ios-7-best-practices-part-2/">[译]iOS7最佳实践：一个天气App案例(二)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/11/yi--ios-7-best-practices-part-1/">[译]iOS7最佳实践：一个天气App案例(一)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/06/kai-shi-xie-blog/">开始写Blog</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/30/2013summer/">2013年终总结</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/09/2012summary/">2012年终总结</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>About Me</h1>
  <p>程序员</p>
  <p>技术经历：As -> Js -> iOS</p>
  <p>新浪微博：<a href="http://weibo.com/sjpsega">IORI_YAGAMI_7</a></p>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - sjpsega -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  









<!--cnzz统计-->
<script src="http://s13.cnzz.com/stat.php?id=5808684&web_id=5808684" language="JavaScript"></script>

</body>
</html>
